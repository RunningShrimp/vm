# VM Engine 性能基准测试套件

本目录包含VM引擎的全面性能基准测试，使用Criterion框架实现。

## 基准测试概述

### 1. JIT编译器性能基准测试 (`jit_compilation_bench.rs`)

测试JIT编译器的各项性能指标：

- **编译速度**: 测试不同IR块大小（10-5000条指令）的编译时间
- **内存使用**: 评估不同代码大小的内存消耗
- **代码缓存**: 对比缓存命中/未命中的性能差异
- **优化级别**: 比较无优化、标准优化、激进优化的性能
- **热点检测**: 模拟热点检测和自适应编译
- **编译吞吐量**: 批量编译的吞吐量测试
- **操作类型**: 对比算术、内存、分支等不同操作的性能

运行方式：
```bash
cargo bench --bench jit_compilation_bench
```

### 2. TLB查找性能基准测试 (`tlb_lookup_bench.rs`)

测试虚拟内存管理中TLB的性能：

- **缓存对比**: 无缓存 vs 有缓存的性能差异
- **缓存大小**: 不同TLB大小（16-1024条目）的性能
- **访问模式**: 顺序、随机、循环访问模式的性能
- **批量查找**: 批量TLB查找的性能
- **刷新开销**: TLB刷新的性能开销
- **竞争条件**: 模拟地址空间切换的性能影响
- **替换策略**: FIFO vs LRU的性能对比
- **预取**: 预取对性能的影响

运行方式：
```bash
cargo bench --bench tlb_lookup_bench
```

### 3. 跨架构翻译性能基准测试 (`cross_arch_translation_bench.rs`)

测试RISC-V到x86的翻译性能：

- **基础翻译**: 不同大小IR块的翻译性能
- **指令融合**: 测试指令融合优化的效果
- **常量传播**: 常量传播优化的性能
- **死代码消除**: DCE优化的性能
- **翻译缓存**: 翻译缓存的性能影响
- **操作类型**: 算术、内存、分支操作的翻译性能
- **综合优化**: 多种优化组合的性能

运行方式：
```bash
cargo bench --bench cross_arch_translation_bench
```

### 4. PGO性能改进基准测试 (`pgo_performance_bench.rs`)

测试Profile-Guided Optimization的性能影响：

- **PGO对比**: 有无PGO的编译性能对比
- **路径类型**: 冷路径、温路径、热路径的性能差异
- **优化级别**: 不同PGO优化级别的性能
- **编译开销**: PGO的编译时间开销
- **执行收益**: PGO优化后的执行时间收益
- **内存使用**: PGO的内存使用情况
- **Profile收集**: Profile数据收集的开销
- **热路径检测**: 热路径识别的准确性

运行方式：
```bash
cargo bench --bench pgo_performance_bench
```

### 5. 异步批处理性能基准测试 (`async_batch_bench.rs`)

测试异步执行和批处理的性能：

- **批量执行**: JIT vs 解释器的批量执行性能
- **单次执行**: 单次执行的性能对比
- **缓存效果**: 不同缓存命中率的影响
- **缓存大小**: 不同工作集大小的性能
- **吞吐量**: 各种执行器的吞吐量
- **并发执行**: 模拟并发执行的性能
- **冷热启动**: 冷启动 vs 热启动的性能
- **模式切换**: JIT/解释器切换的开销
- **内存使用**: 不同缓存数量的内存消耗
- **批处理优化**: 寻找最优批处理大小
- **统计开销**: 统计信息收集的开销

运行方式：
```bash
cargo bench --bench async_batch_bench
```

### 6. 性能基线 (`baseline.rs`)

定义性能基线和回归检测：

- **基线定义**: 定义各模块的性能基线
- **回归检测**: 自动检测性能回归
- **阈值配置**: 配置允许的性能波动范围
- **基线测试**: 运行基线对比测试

运行方式：
```bash
cargo test --bench baseline
```

## 运行所有基准测试

运行所有基准测试：
```bash
cargo bench
```

运行特定基准测试：
```bash
cargo bench --bench <bench_name>
```

## 基准测试输出

基准测试结果会保存在 `target/criterion/` 目录下，包含：

- HTML格式的详细报告
- 性能图表和趋势
- 统计数据（平均值、标准差、中位数等）

查看报告：
```bash
open target/criterion/<benchmark_name>/report/index.html
```

## 性能基线对比

基线数据定义在 `baseline.rs` 中，包括：

- JIT编译时间：100条指令 ≤ 50μs，1000条指令 ≤ 500μs
- TLB查找：缓存命中 ≤ 50ns，未命中 ≤ 500ns
- 翻译性能：100条指令 ≤ 100μs
- PGO编译：热路径 ≤ 1ms，冷路径 ≤ 100μs

## 回归检测

运行回归检测：
```bash
cargo test --bench baseline -- --nocapture
```

检测规则：
- 允许 10-15% 的性能退化（取决于模块）
- 超过 40-60% 的性能改善会被标记为异常
- 检测到回归会返回错误

## 性能分析建议

### 优化优先级

根据基准测试结果，优化优先级如下：

1. **JIT编译速度**: 最关键的路径，直接影响启动性能
2. **TLB缓存命中率**: 内存访问性能的关键
3. **翻译优化**: 指令融合和常量传播带来显著提升
4. **PGO热路径识别**: 对频繁执行代码的性能影响大
5. **批处理优化**: 批量操作可以显著提高吞吐量

### 性能目标

- JIT编译：1000条指令 < 500μs
- TLB命中率：> 80%
- 翻译缓存命中率：> 70%
- PGO性能提升：热路径 > 20%
- 批处理吞吐量：> 10000 ops/sec

## 统计显著性

所有基准测试配置为：
- 预热时间：2-3秒
- 测量时间：5-10秒
- 样本数：100
- 置信度：95%

## 真实工作负载模拟

基准测试尽可能模拟真实场景：

- **混合操作**: 包含算术、内存、分支等多种操作
- **不同大小**: 从10到5000条指令的不同规模
- **访问模式**: 顺序、随机、循环等真实访问模式
- **冷热路径**: 模拟真实程序中的冷热代码分布

## 故障排除

### 基准测试编译错误

确保依赖已安装：
```bash
cargo build --benches
```

### 基准测试运行缓慢

可以减少样本数量或测量时间（修改各bench文件中的 `configure_criterion()` 函数）

### 性能波动大

- 关闭其他应用程序
- 使用 `--sample-size` 增加样本数
- 使用 `--warm-up-time` 增加预热时间
- 禁用CPU频率缩放（`sudo cpupower frequency-set -g performance`）

## 贡献指南

添加新基准测试时：

1. 在对应的bench文件中添加测试函数
2. 使用 `BenchmarkId` 支持参数化测试
3. 配置适当的 `Throughput` 用于吞吐量测试
4. 使用 `black_box` 防止编译器优化掉代码
5. 更新 `baseline.rs` 添加新的性能基线
6. 在本README中记录新测试的说明

## 参考资料

- [Criterion用户指南](https://bheisler.github.io/criterion.rs/book/)
- [Rust性能优化指南](https://nnethercote.github.io/perf-book/)
- [VM Engine架构文档](../README.md)
