[package]
name = "vm-engine"
version = "0.1.0"
edition = "2024"

[dependencies]
# Hakari-managed dependencies
vm-build-deps = { path = "../../architecture/vm-build-deps" }
# Async runtime - must be first to ensure availability
tokio = { workspace = true, features = ["sync", "rt", "rt-multi-thread", "time", "macros"] }

log = { workspace = true }
parking_lot = { workspace = true }
serde = { workspace = true }
serde_json = { workspace = true, optional = true }
bincode = { workspace = true }
uuid = { workspace = true }
chrono = { workspace = true, optional = true }
anyhow = { workspace = true }
thiserror = { workspace = true }

# JIT编译后端 - Cranelift (使用 workspace 统一版本)
cranelift-codegen = { workspace = true }
cranelift-frontend = { workspace = true }
cranelift-module = { workspace = true }
cranelift-native = { workspace = true }
cranelift-control = { workspace = true }
target-lexicon = { workspace = true }

# 缓存和并发数据结构 (使用 workspace 统一版本)
lru = { workspace = true }
crossbeam-queue = { workspace = true }

# VM Core dependencies
vm-core = { path = "../../core/vm-core" }
vm-mem = { path = "../../memory/vm-mem" }
vm-ir = { path = "../../core/vm-ir" }
# vm-optimizers = { path = "../../memory/vm-optimizers" }  # Temporarily disabled due to merge conflicts

# Optional external dependencies
vm-accel = { path = "../../platform/vm-accel", optional = true }
vm-engine-jit = { path = "../../execution/vm-engine-jit", optional = true }

# Build dependencies
# cfg-if 保留直接版本，因为它是构建时依赖且版本稳定
cfg-if = "1.0"

# System dependencies
[target.'cfg(unix)'.dependencies]
libc = "0.2"
nix = { version = "0.29", optional = true }

[target.'cfg(target_os = "linux")'.dependencies]
num_cpus = { version = "1.16", optional = true }
tokio-uring = { workspace = true, optional = true }

# Async dependencies
futures = { workspace = true, optional = true }
async-trait = { workspace = true, optional = true }

[target.'cfg(windows)'.dependencies]
windows-sys = { version = "0.61", features = ["Win32_Foundation", "Win32_System_Memory"] }

[features]
default = ["std", "interpreter"]

# Standard library support
std = ["serde_json", "vm-core/std"]

# Execution engines
# Note: Both interpreter and JIT are always compiled, but features control optimizations
interpreter = []
jit = []  # JIT is compiled-in, see src/jit/mod.rs for JIT-specific code

# Full JIT engine with vm-engine-jit integration (方案C: Feature统一)
jit-full = ["jit", "vm-engine-jit"]

# Executor (async execution)
executor = ["async"]

# Debugging support
debug = ["std"]

# Async support
async = ["futures", "async-trait", "vm-core/async"]

# Combined features
all-engines = ["interpreter", "jit"]
all-engines-full = ["interpreter", "jit-full"]

# Experimental features
experimental = ["executor"]

[dev-dependencies]
criterion = { workspace = true }
rand = "0.8"
proptest = "1.0"
vm-cross-arch-support = { path = "../../architecture/vm-cross-arch-support" }

[[bench]]
name = "jit_compilation_bench"
harness = false

[[bench]]
name = "tlb_lookup_bench"
harness = false

[[bench]]
name = "cross_arch_translation_bench"
harness = false

[[bench]]
name = "p1_2_cache_bench"
harness = false

[[bench]]
name = "pgo_performance_bench"
harness = false

[[bench]]
name = "async_batch_bench"
harness = false
