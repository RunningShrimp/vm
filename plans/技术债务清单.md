# 技术债务清单

## 概述

本文档记录 Rust 虚拟机项目的所有技术债务，按优先级和类别组织。技术债务是可执行的改进项，需要在未来的开发中逐步偿还。

## 债务分类

- 🔴 **P0 - 紧急**（阻塞开发或严重影响功能）
- 🟠 **P1 - 高优先级**（影响性能或可维护性）
- 🟡 **P2 - 中优先级**（代码质量或用户体验问题）
- 🟢 **P3 - 低优先级**（优化或改进项）

## 目录

1. [构建和依赖](#构建和依赖)
2. [代码质量](#代码质量)
3. [架构和设计](#架构和设计)
4. [性能优化](#性能优化)
5. [功能完整性](#功能完整性)
6. [文档和测试](#文档和测试)
7. [安全性和合规性](#安全性和合规性)

---

## 构建和依赖

### P0 - 紧急

#### 债务 B001：vm-build-deps 路径错误
**状态**：🔴 阻塞性
**影响**：项目无法编译
**描述**：
- vm-build-deps 路径引用错误导致构建失败
- 错误路径：`tools/crates/architecture/vm-build-deps`
- 正确路径：`crates/architecture/vm-build-deps`

**修复计划**：
- [ ] 定位 vm-build-deps 实际位置
- [ ] 更新所有引用 vm-build-deps 的 Cargo.toml
- [ ] 验证项目可编译

**预计工作量**：6-8 小时
**依赖**：无
**负责人**：待分配
**链接**：[01-紧急修复计划.md](./01-紧急修复计划.md)

---

## 代码质量

### P1 - 高优先级

#### 债务 CQ001：Cranelift 版本严重过旧
**状态**：🔴 严重
**影响**：性能损失 5-10%，缺少最新特性
**描述**：
- 当前版本：=0.110.3
- 最新版本：0.127.2
- 版本差距：17 个小版本
- 影响：缺少最新优化、架构支持和 bug 修复

**修复计划**：
- [ ] 研究 Cranelift 变更日志
- [ ] 识别破环性变更
- [ ] 更新到 0.127.2
- [ ] 修复 API 变更
- [ ] 测试和验证

**预计工作量**：3-4 天
**依赖**：B001
**负责人**：待分配
**链接**：[02-依赖升级计划.md](./02-依赖升级计划.md)

#### 债务 CQ002：228 处 #[allow] 属性
**状态**：🔴 严重
**影响**：代码质量不高，潜在 bug，维护困难
**描述**：
- 未使用变量：~80 处
- 死代码：~50 处
- Clippy 警告被压制：~40 处
- 命名风格不一致：~20 处
- 不可达代码：~34 处

**修复计划**：
- [ ] 修复未使用变量（删除或使用 `_` 前缀）
- [ ] 删除死代码（或移到 research/）
- [ ] 修复 Clippy 警告（遵循建议）
- [ ] 统一命名风格
- [ ] 清理不可达代码

**预计工作量**：2-3 周
**依赖**：CQ001
**负责人**：待分配
**链接**：[03-代码质量清理计划.md](./03-代码质量清理计划.md)

#### 债务 CQ003：32 处 TODO/FIXME/XXX/HACK 标记
**状态**：🟠 高
**影响**：功能不完整，技术债务标记
**描述**：
- TODO：待实现功能
- FIXME：需要修复的代码
- XXX：需要改进的代码
- HACK：临时解决方案

**示例位置**：
- `crates/runtime/vm-service/src/vm_service/realmode.rs`（12 处 TODO）
- `crates/core/vm-core/src/foundation/support_macros.rs`（支持宏定义）
- `crates/core/vm-core/src/unified_executor.rs`（1 处 TODO）

**修复计划**：
- [ ] 完成 TODO 标记的功能
- [ ] 修复 FIXME 标记的问题
- [ ] 重构 XXX 标记的代码
- [ ] 移除或完善 HACK 代码
- [ ] 使用实际实现替代宏

**预计工作量**：1-2 周
**依赖**：CQ002
**负责人**：待分配

#### 候务 CQ004：34 处 unreachable!() 使用
**状态**：🟠 高
**影响**：可能掩盖 bug，代码完整性问题
**描述**：
- 部分 `unreachable!()` 用于代码完整性检查
- 可能掩盖实际的运行时错误
- 需要审查每个使用点

**示例位置**：
- `crates/runtime/vm-service/src/vm_service/realmode.rs`（12 处）
- `crates/memory/vm-mem/benches/tlb_enhanced_stats_bench.rs`（4 处）
- `crates/execution/vm-engine-jit/src/lib.rs`（2 处）

**修复计划**：
- [ ] 审查每个 `unreachable!()` 使用
- [ ] 使用明确的错误处理替代
- [ ] 保留用于真正的不可达代码
- [ ] 添加文档说明为什么不可达

**预计工作量**：3-5 天
**依赖**：CQ002
**负责人**：待分配

### P2 - 中优先级

#### 候务 CQ005：版本不一致
**状态**：🟡 中
**影响**：构建警告，版本管理混乱
**描述**：
- lru：workspace 0.12 vs vm-mem 0.16
- criterion：workspace 0.5 vs dev-deps 0.8

**修复计划**：
- [ ] 统一 lru 到 workspace 版本
- [ ] 统一 criterion 到 workspace 版本
- [ ] 验证无构建警告

**预计工作量**：1 天
**依赖**：CQ001
**负责人**：待分配
**链接**：[02-依赖升级计划.md](./02-依赖升级计划.md)

---

## 架构和设计

### P1 - 高优先级

#### 债务 AD001：模块拆分过细（24 个 crates）
**状态**：🟠 高
**影响**：依赖复杂度高，编译时间长，维护成本高
**描述**：
- 当前：24 个 workspace crates
- 问题：
  - vm-engine 与 vm-engine-jit 功能重叠
  - vm-graphics, vm-smmu, vm-soc 职责类似
  - security-sandbox, syscall-compat 可合并
- 目标：减少到 20 个 crates

**修复计划**：
- [ ] 合并 vm-engine + vm-engine-jit → vm-execution
- [ ] 合并 vm-graphics + vm-smmu + vm-soc → vm-devices
- [ ] 合并 security-sandbox + syscall-compat → vm-compat
- [ ] 统一优化器到 vm-optimizers
- [ ] 更新所有依赖路径
- [ ] 性能回归测试

**预计工作量**：2-3 周
**依赖**：CQ002, CQ003
**负责人**：待分配
**链接**：[04-模块重构计划.md](./04-模块重构计划.md)

#### 债务 AD002：条件编译滥用（72 个文件）
**状态**：🟠 高
**影响**：编译配置矩阵爆炸，测试覆盖困难，代码可读性下降
**描述**：
- 72 个文件使用 `#[cfg(feature = "...")]`
- 模糊特性：`async`, `optimizations`, `performance`
- 问题：
  - 特性组合数量多（2^n）
  - 难以测试所有组合
  - 模块边界模糊

**修复计划**：
- [ ] 简化特性定义（减少 50%）
- [ ] 使用 trait 抽象替代条件编译
- [ ] 删除模糊特性（`performance`, `optimizations`）
- [ ] 明确特性命名
- [ ] 测试所有特性组合

**预计工作量**：1-2 周
**依赖**：AD001
**负责人**：待分配
**链接**：[05-条件编译简化计划.md](./05-条件编译简化计划.md)

### P2 - 中优先级

#### 候务 AD003：JIT 与执行引擎集成不完整
**状态**：🟡 中
**影响**：性能优化受限，架构不清晰
**描述**：
- vm-engine 和 vm-engine-jit 功能重叠
- 统一执行路径不完整
- 混合执行策略未完全实现

**修复计划**：
- [ ] 统一执行引擎接口
- [ ] 实现完整的混合执行策略
- [ ] 优化执行路径选择
- [ ] 完善集成测试

**预计工作量**：1-2 周
**依赖**：AD001
**负责人**：待分配
**链接**：[04-模块重构计划.md](./04-模块重构计划.md)

#### 候务 AD004：AOT 编译不完整
**状态**：🟡 中
**影响**：启动性能受限，无法预编译热点
**描述**：
- AOT 框架存在但未完全实现
- 缺少 AOT 缓存持久化
- 无法提前编译热点代码

**修复计划**：
- [ ] 完整实现 AOT 编译器
- [ ] 实现 AOT 缓存机制
- [ ] 支持热点代码预编译
- [ ] 实现 AOT 加载和执行

**预计工作量**：2-3 周
**依赖**：AD003
**负责人**：待分配

---

## 性能优化

### P1 - 高优先级

#### 候务 PO001：跨架构翻译性能开销大
**状态**：🟠 高
**影响**：跨架构执行性能损失 50-300ns/指令
**描述**：
- 当前开销：50-300ns/指令
- 目标开销：<100ns/指令
- 优化点：
  - 翻译缓存命中率提升
  - 模式匹配覆盖率提升
  - 寄存器映射优化

**修复计划**：
- [ ] 优化翻译缓存策略
- [ ] 实现模式匹配优化
- [ ] 优化寄存器映射缓存
- [ ] 考虑硬件虚拟化加速

**预计工作量**：2-3 周
**依赖**：AD003
**负责人**：待分配

#### 候务 PO002：GC 暂停时间长
**状态**：🟠 高
**影响**：应用程序吞吐量损失，用户体验差
**描述**：
- 分代 GC：50-200ms（老年代）
- 目标：<50ms（老年代）
- 优化点：
  - 写屏障优化
  - 并发度提升
  - 分代策略调优

**修复计划**：
- [ ] 优化写屏障实现
- [ ] 增加并发标记线程
- [ ] 实现自适应分代策略
- [ ] 性能基准测试

**预计工作量**：1-2 周
**依赖**：无
**负责人**：待分配

### P2 - 中优先级

#### 候务 PO003：TLB 未命中惩罚大
**状态**：🟡 中
**影响**：内存访问性能损失 50-200ns
**描述**：
- 当前未命中惩罚：50-200ns
- 目标未命中惩罚：<100ns
- 优化点：
  - TLB 预取
  - 多级缓存优化
  - 大页支持

**修复计划**：
- [ ] 实现 TLB 预取机制
- [ ] 优化多级缓存策略
- [ ] 实现大页支持（huge page）
- [ ] 性能基准测试

**预计工作量**：1-2 周
**依赖**：无
**负责人**：待分配

---

## 功能完整性

### P1 - 高优先级

#### 候务 FI001：SIMD 指令集实现不完整
**状态**：🟠 高
**影响**：高性能应用性能受限
**描述**：

**x86_64**：
- SSE：~30% 实现
- AVX/AVX2：部分实现
- AVX-512：未实现

**ARM64**：
- NEON：~40% 实现
- SVE：未实现

**RISC-V64**：
- RVV：~30% 实现
- 扩展指令部分实现

**修复计划**：
- [ ] 补充 x86_64 SSE/AVX 指令
- [ ] 补充 ARM64 NEON 指令
- [ ] 实现 ARM64 SVE 基础支持
- [ ] 补充 RISC-V RVV 指令
- [ ] 实现扩展指令集
- [ ] 指令集测试覆盖

**预计工作量**：4-6 周
**依赖**：CQ002
**负责人**：待分配

#### 候务 FI002：ARM64 ↔ RISC-V64 翻译部分实现
**状态**：🟠 高
**影响**：跨架构功能受限
**描述**：
- x86_64 ↔ ARM64：✅ 完整
- x86_64 ↔ RISC-V64：✅ 完整
- ARM64 ↔ RISC-V64：🚧 部分实现
- RISC-V64 ↔ ARM64：🚧 部分实现

**修复计划**：
- [ ] 实现 ARM64 → RISC-V64 翻译
- [ ] 实现 RISC-V64 → ARM64 翻译
- [ ] 优化翻译性能
- [ ] 集成测试

**预计工作量**：2-3 周
**依赖**：FI001
**负责人**：待分配

#### 候务 FI003：硬件虚拟化加速集成不完整
**状态**：🟠 高
**影响**：性能未充分利用硬件
**描述**：

**KVM**：
- ✅ 完整实现

**HVF（macOS ARM64）**：
- ⚠️ 部分实现
- ⚠️ 测试不完整

**WHP（Windows x86_64）**：
- ⚠️ 部分实现
- ⚠️ 测试不完整

**修复计划**：
- [ ] 完善 HVF 实现
- [ ] 完善 WHP 实现
- [ ] 统一硬件加速抽象层
- [ ] 集成到执行路径
- [ ] 完整测试

**预计工作量**：3-4 周
**依赖**：AD003
**负责人**：待分配

---

## 文档和测试

### P2 - 中优先级

#### 候务 DT001：测试覆盖率未知
**状态**：🟡 中
**影响**：无法评估代码质量，遗漏 bug 风险
**描述**：
- 未配置覆盖率工具
- 测试覆盖率指标缺失
- 无法量化测试质量

**修复计划**：
- [ ] 配置 tarpaulin 或 cargo-llvm-cov
- [ ] 生成覆盖率报告
- [ ] 设定覆盖率目标（70%+）
- [ ] 持续监控覆盖率

**预计工作量**：3-5 天
**依赖**：无
**负责人**：待分配
**链接**：[06-测试覆盖率提升计划.md](./06-测试覆盖率提升计划.md)

#### 候务 DT002：端到端测试缺失
**状态**：🟡 中
**影响**：集成问题难以发现
**描述**：
- 缺少完整的 VM 启动测试
- 缺少跨架构翻译的集成测试
- 缺少完整的执行流程测试

**修复计划**：
- [ ] 添加 VM 启动测试
- [ ] 添加跨架构翻译测试
- [ ] 添加执行流程测试
- [ ] 自动化端到端测试

**预计工作量**：1-2 周
**依赖**：DT001
**负责人**：待分配
**链接**：[06-测试覆盖率提升计划.md](./06-测试覆盖率提升计划.md)

#### 候务 DT003：API 文档不完整
**状态**：🟡 中
**影响**：开发者使用困难，上手慢
**描述**：
- 子模块文档不完整
- 公共 API 缺少文档注释
- 缺少架构决策记录（ADR）

**修复计划**：
- [ ] 为所有公共 API 添加文档注释
- [ ] 添加架构决策记录（ADR）
- [ ] 完善开发者指南
- [ ] 验证无文档警告

**预计工作量**：1 周
**依赖**：无
**负责人**：待分配
**链接**：[07-最终验证计划.md](./07-最终验证计划.md)

---

## 安全性和合规性

### P3 - 低优先级

#### 候务 SC001：安全审计未完成
**状态**：🟢 低
**影响**：潜在安全风险未识别
**描述**：
- 未进行安全审计
- 未进行依赖安全扫描
- 未进行代码安全审查

**修复计划**：
- [ ] 进行依赖安全扫描（cargo audit）
- [ ] 进行代码安全审查
- [ ] 修复发现的安全问题
- [ ] 建立持续安全检查

**预计工作量**：1 周
**依赖**：无
**负责人**：待分配

---

## 技术债务总结

### 优先级分布

| 优先级 | 数量 | 预计总工作量 |
|--------|------|--------------|
| P0 - 紧急 | 1 | 6-8 小时 |
| P1 - 高优先级 | 9 | 10-15 周 |
| P2 - 中优先级 | 7 | 6-10 周 |
| P3 - 低优先级 | 1 | 1 周 |
| **总计** | **18** | **16-27 周** |

### 类别分布

| 类别 | 数量 | 主要债务 |
|------|------|----------|
| 构建和依赖 | 1 | vm-build-deps 路径错误 |
| 代码质量 | 5 | Cranelift 版本, #[allow], TODO, unreachable!(), 版本不一致 |
| 架构和设计 | 4 | 模块拆分, 条件编译, JIT 集成, AOT |
| 性能优化 | 3 | 跨架构翻译, GC 暂停, TLB 未命中 |
| 功能完整性 | 3 | SIMD 指令, ARM64↔RISC-V64 翻译, 硬件虚拟化 |
| 文档和测试 | 3 | 测试覆盖率, 端到端测试, API 文档 |
| 安全性和合规性 | 1 | 安全审计 |

### 还款时间表

| 季度 | P0 | P1 | P2 | P3 | 重点 |
|------|-----|-----|-----|-----|------|
| Q1 | B001 | CQ001, CQ002, AD001, AD002, PO001, PO002, FI001, FI002, FI003 | DT001, DT002, DT003 | - | 紧急修复, 依赖升级, 代码质量, 架构重构 |
| Q2 | - | CQ003, CQ004, AD003, AD004, PO003 | - | SC001 | 完成代码清理, 完成 JIT/AOT 集成 |
| Q3 | - | - | - | - | 性能优化, 功能补充 |

## 管理流程

### 债务登记
- 新债务发现时立即登记到此文档
- 指定优先级、类别、负责人和预计工作量
- 关联相关文档和计划

### 债务跟踪
- 定期审查债务状态（每月）
- 更新债务优先级（根据项目需求变化）
- 记录偿还进度和实际工作量

### 债务偿还
- 按优先级顺序偿还债务
- P0 债务立即处理
- P1 债务按计划处理
- P2/P3 债务根据资源情况处理

### 债务审查
- 每季度审查债务清单
- 评估债务影响和优先级
- 调整偿还计划
- 记录决策和理由

## 附录

### A. 债务编号规则
- BXXX：构建和依赖（Build）
- CQXXX：代码质量（Code Quality）
- ADXXX：架构和设计（Architecture/Design）
- POXXX：性能优化（Performance Optimization）
- FIXXX：功能完整性（Feature Implementation）
- DTXXX：文档和测试（Documentation/Testing）
- SCXXX：安全性和合规性（Security/Compliance）

### B. 参考资料
- [Technical Debt Definition](https://martinfowler.com/bliki/TechnicalDebt.html)
- [Debt Management Best Practices](https://www.thoughtworks.com/insights/blog/managing-technical-debt)

---

**文档版本**：1.0  
**创建日期**：2026-01-20  
**最后更新**：2026-01-20  
**负责人**：待分配  
**下次审查**：2026-04-20
