name: Performance Benchmarks

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # æ¯å‘¨è¿è¡ŒåŸºå‡†æµ‹è¯•
    - cron: '0 2 * * 1'

env:
  RUST_BACKTRACE: 1

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-benchmark-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-criterion
      run: cargo install cargo-criterion

    - name: Build release
      run: cargo build --release --all-features

    - name: Run JIT benchmarks
      run: |
        echo "Running JIT benchmarks..."
        cargo bench --release --package vm-tests --bench jit_benchmarks -- --output-format html

    - name: Run TLB benchmarks
      run: |
        echo "Running TLB benchmarks..."
        cargo bench --release --package vm-tests --bench tlb_benchmarks -- --output-format html

    - name: Run Memory benchmarks
      run: |
        echo "Running Memory benchmarks..."
        cargo bench --release --package vm-tests --bench memory_benchmarks -- --output-format html

    - name: Run System benchmarks
      run: |
        echo "Running System benchmarks..."
        cargo bench --release --package vm-tests --bench system_benchmarks -- --output-format html

    - name: Generate benchmark summary
      run: |
        echo "# Benchmark Results" > benchmark-summary.md
        echo "Generated on: $(date)" >> benchmark-summary.md
        echo "" >> benchmark-summary.md

        # æå–å…³é”®åŸºå‡†æµ‹è¯•ç»“æžœ
        if [ -d "target/criterion" ]; then
          echo "## JIT Performance" >> benchmark-summary.md
          find target/criterion -name "report" -type d | head -5 | while read dir; do
            if [ -f "$dir/index.html" ]; then
              echo "- $(basename $(dirname $dir))" >> benchmark-summary.md
            fi
          done
        fi

    - name: Upload benchmark reports
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-reports
        path: |
          target/criterion/
          benchmark-summary.md
        if: always()

    - name: Compare with main branch
      if: github.event_name == 'pull_request'
      run: |
        # å®‰è£…critcmpç”¨äºŽæ¯”è¾ƒåŸºå‡†æµ‹è¯•ç»“æžœ
        cargo install critcmp

        # ä¿å­˜å½“å‰åŸºå‡†æµ‹è¯•ç»“æžœ
        cargo bench --release --all-features -- --save-baseline current

        # å¦‚æžœæœ‰åŸºçº¿ç»“æžœï¼Œè¿›è¡Œæ¯”è¾ƒ
        if [ -f "target/criterion/baseline.json" ]; then
          echo "## Performance Comparison" >> benchmark-summary.md
          critcmp main current >> benchmark-summary.md || true
        fi

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          try {
            const summary = fs.readFileSync('benchmark-summary.md', 'utf8');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“Š Performance Benchmark Results\n\n${summary}`
            });
          } catch (error) {
            console.log('Could not read benchmark summary:', error);
          }