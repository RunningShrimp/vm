name: Documentation Coverage

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]
  workflow_dispatch:
  # æ¯å‘¨ä¸€æ—©ä¸Š6ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 6 * * 1'

jobs:
  # ============================================================================
  # æ–‡æ¡£è¦†ç›–çŽ‡æ£€æŸ¥
  # ============================================================================
  coverage:
    name: Documentation Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build documentation
        run: |
          echo "## Documentation Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ­£åœ¨æž„å»ºæ–‡æ¡£..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æž„å»ºæ–‡æ¡£å¹¶æ£€æŸ¥æœªæ–‡æ¡£åŒ–çš„é¡¹ç›®
          cargo doc --no-deps --all-features 2>&1 | tee /tmp/doc-build.log

          # ç»Ÿè®¡æ–‡æ¡£è¦†ç›–çŽ‡
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if grep -q "warning: unused" /tmp/doc-build.log; then
            echo "âš ï¸ å­˜åœ¨æœªä½¿ç”¨çš„æ–‡æ¡£è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æ–‡æ¡£æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check for missing docs
        run: |
          echo "### Missing Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æŸ¥æ‰¾ç¼ºå°‘æ–‡æ¡£çš„å…¬å…±å‡½æ•°
          MISSING_DOCS=$(cargo doc --no-deps --all-features 2>&1 | grep "missing documentation" | wc -l)

          echo "**Missing documentation items**: $MISSING_DOCS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$MISSING_DOCS" -gt 0 ]; then
            echo "âš ï¸ å‘çŽ°ç¼ºå°‘æ–‡æ¡£çš„å…¬å…±API" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cargo doc --no-deps --all-features 2>&1 | grep "missing documentation" | head -50 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æ‰€æœ‰å…¬å…±APIéƒ½æœ‰æ–‡æ¡£" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check module-level docs
        run: |
          echo "### Module Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥ä¸»è¦crateæ˜¯å¦æœ‰æ¨¡å—çº§æ–‡æ¡£
          echo "| Crate | Has lib.rs doc | Has README |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------------|------------|" >> $GITHUB_STEP_SUMMARY

          for crate_dir in vm-*; do
            if [ -f "$crate_dir/Cargo.toml" ]; then
              crate_name=$(basename "$crate_dir")
              lib_doc="âŒ"
              readme="âŒ"

              # æ£€æŸ¥lib.rsæ˜¯å¦æœ‰æ¨¡å—çº§æ–‡æ¡£
              if [ -f "$crate_dir/src/lib.rs" ]; then
                if grep -q "^//!" "$crate_dir/src/lib.rs"; then
                  lib_doc="âœ…"
                fi
              fi

              # æ£€æŸ¥æ˜¯å¦æœ‰README
              if [ -f "$crate_dir/README.md" ]; then
                readme="âœ…"
              fi

              echo "| $crate_name | $lib_doc | $readme |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check example code
        run: |
          echo "### Example Code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ç»Ÿè®¡ç¤ºä¾‹ä»£ç æ•°é‡
          EXAMPLE_COUNT=$(find . -name "examples/*.rs" -o -name "examples/*.md" 2>/dev/null | wc -l | awk '{print $1}')

          echo "**Example files**: $EXAMPLE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$EXAMPLE_COUNT" -gt 0 ]; then
            echo "### Found Examples" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            find . -name "examples/*.rs" -o -name "examples/*.md" 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æœªå‘çŽ°ç¤ºä¾‹ä»£ç " >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check doc tests
        run: |
          echo "### Documentation Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¿è¡Œæ–‡æ¡£æµ‹è¯•
          echo "æ­£åœ¨è¿è¡Œæ–‡æ¡£æµ‹è¯•..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if cargo test --doc --all-features 2>&1 | tee /tmp/doctest.log; then
            echo "âœ… æ‰€æœ‰æ–‡æ¡£æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ éƒ¨åˆ†æ–‡æ¡£æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/doctest.log | tail -100 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # æ–‡æ¡£è´¨é‡æ£€æŸ¥
  # ============================================================================
  quality:
    name: Documentation Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Check doc warnings
        run: |
          echo "## Documentation Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥æ–‡æ¡£è­¦å‘Š
          cargo doc --no-deps --all-features 2>&1 | grep -i "warning" > /tmp/doc-warnings.txt || true

          WARNING_COUNT=$(wc -l < /tmp/doc-warnings.txt | awk '{print $1}')

          echo "**Warnings**: $WARNING_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$WARNING_COUNT" -gt 0 ]; then
            echo "### Documentation Warnings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/doc-warnings.txt | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æ²¡æœ‰æ–‡æ¡£è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check for broken links
        run: |
          echo "### Link Checking" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥æ–‡æ¡£ä¸­çš„é“¾æŽ¥ï¼ˆåŸºç¡€æ£€æŸ¥ï¼‰
          BROKEN_LINKS=$(grep -r "\[.*\](" --include="*.rs" | grep -v "https://" | wc -l | awk '{print $1}')

          echo "**Internal references**: $BROKEN_LINKS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥æ˜¯å¦æœ‰å¤–éƒ¨é“¾æŽ¥
          EXTERNAL_LINKS=$(grep -r "https://" --include="*.rs" | wc -l | awk '{print $1}')
          echo "**External links**: $EXTERNAL_LINKS" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check parameter documentation
        run: |
          echo "### Parameter Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥å…¬å…±å‡½æ•°æ˜¯å¦æœ‰å‚æ•°æ–‡æ¡£
          # ç®€åŒ–ç‰ˆï¼šæ£€æŸ¥æ˜¯å¦æœ‰ /// æ–‡æ¡£æ³¨é‡Š
          PUBLIC_FUNCS=$(find . -name "*.rs" -not -path "./target/*" -exec grep -l "^pub fn" {} \; | wc -l | awk '{print $1}')
          DOCUMENTED_FUNCS=$(find . -name "*.rs" -not -path "./target/*" -exec grep -B1 "^pub fn" {} \; | grep -c "^///" || echo "0")

          echo "**Public functions**: $PUBLIC_FUNCS" >> $GITHUB_STEP_SUMMARY
          echo "**Documented functions**: $DOCUMENTED_FUNCS" >> $GITHUB_STEP_SUMMARY

          if [ "$PUBLIC_FUNCS" -gt 0 ]; then
            COVERAGE=$((DOCUMENTED_FUNCS * 100 / PUBLIC_FUNCS))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Coverage**: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY

            if [ $COVERAGE -lt 60 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ æ–‡æ¡£è¦†ç›–çŽ‡ä½ŽäºŽ60%ç›®æ ‡" >> $GITHUB_STEP_SUMMARY
            elif [ $COVERAGE -lt 80 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“Š æ–‡æ¡£è¦†ç›–çŽ‡æŽ¥è¿‘ç›®æ ‡" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… æ–‡æ¡£è¦†ç›–çŽ‡è‰¯å¥½" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # æ–‡æ¡£è¦†ç›–çŽ‡ç»Ÿè®¡
  # ============================================================================
  stats:
    name: Documentation Statistics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate documentation stats
        run: |
          echo "## Documentation Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ€»ä½“ç»Ÿè®¡
          TOTAL_RS=$(find . -name "*.rs" -not -path "./target/*" -not -path "./vm-build-deps/*" | wc -l | awk '{print $1}')
          DOC_LINES=$(find . -name "*.rs" -not -path "./target/*" -not -path "./vm-build-deps/*" -exec cat {} \; | grep -c "^///" || echo "0")
          MOD_LINES=$(find . -name "*.rs" -not -path "./target/*" -not -path "./vm-build-deps/*" -exec cat {} \; | grep -c "^//!" || echo "0")

          echo "### Overall Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Rust files**: $TOTAL_RS" >> $GITHUB_STEP_SUMMARY
          echo "- **Item documentation lines**: $DOC_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- **Module documentation lines**: $MOD_LINES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # å„crateç»Ÿè®¡
          echo "### Per-Crate Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Crate | Public Items | Doc Comments | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------------|---------------|----------|" >> $GITHUB_STEP_SUMMARY

          for crate in vm-core vm-mem vm-engine vm-frontend vm-device vm-accel; do
            if [ -d "$crate/src" ]; then
              PUB_ITEMS=$(find "$crate/src" -name "*.rs" -exec grep -c "^pub" {} \; | awk '{s+=$1} END {print s}')
              DOC_COMMENTS=$(find "$crate/src" -name "*.rs" -exec grep -c "^///" {} \; | awk '{s+=$1} END {print s}')

              if [ "$PUB_ITEMS" -gt 0 ]; then
                COV=$((DOC_COMMENTS * 100 / PUB_ITEMS))
              else
                COV=0
              fi

              printf "| %-15s | %12d | %13d | %8s%% |\n" "$crate" "$PUB_ITEMS" "$DOC_COMMENTS" "$COV" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # æ–‡æ¡£è¦†ç›–æ±‡æ€»
  # ============================================================================
  summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: [coverage, quality, stats]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Documentation Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage Analysis | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Check | ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Statistics | ${{ needs.stats.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ€»ä½“è¯„ä¼°
          if [ "${{ needs.coverage.result }}" == "success" ] && \
             [ "${{ needs.quality.result }}" == "success" ]; then
            echo "âœ… **Overall**: Documentation quality is good" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Overall**: Documentation needs improvement" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommendations**:" >> $GITHUB_STEP_SUMMARY
            echo "- ä¸ºæ‰€æœ‰å…¬å…±APIæ·»åŠ æ–‡æ¡£æ³¨é‡Š" >> $GITHUB_STEP_SUMMARY
            echo "- æ·»åŠ æ¨¡å—çº§æ–‡æ¡£è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
            echo "- è¡¥å……ç¤ºä¾‹ä»£ç " >> $GITHUB_STEP_SUMMARY
            echo "- ä¿®å¤æ–‡æ¡£è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage targets**:" >> $GITHUB_STEP_SUMMARY
          echo "- Public API documentation: > 80%" >> $GITHUB_STEP_SUMMARY
          echo "- Module-level documentation: 100%" >> $GITHUB_STEP_SUMMARY
          echo "- Example code: > 10 files" >> $GITHUB_STEP_SUMMARY
