name: Quality Gates

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]
  merge_group:
    branches: [master, main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: -D warnings
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Format Check - Must Pass
  # ============================================================================
  format:
    name: Format Check (rustfmt)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
          override: true

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Format check summary
        if: failure()
        run: |
          echo "## Format Check Failed ‚ùå" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please run \`cargo fmt\` to fix formatting issues." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cargo fmt" >> $GITHUB_STEP_SUMMARY
          echo "git add -A" >> $GITHUB_STEP_SUMMARY
          echo "git commit -m \"fix: format code\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Clippy Linting - Must Pass (Strict Mode)
  # ============================================================================
  clippy:
    name: Clippy (Strict Mode)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
          override: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-clippy-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-clippy-

      - name: Run Clippy with strict checks
        run: |
          cargo clippy --workspace --all-features --all-targets -- \
            -D warnings \
            -W clippy::all \
            -W clippy::pedantic \
            -W clippy::cargo \
            -W clippy::unwrap_used \
            -W clippy::expect_used \
            -W clippy::panic \
            -W clippy::unimplemented \
            -W clippy::todo \
            -W clippy::unreachable \
            -W clippy::indexing_slicing

      - name: Generate Clippy report
        if: failure()
        run: |
          cargo clippy --workspace --all-features --all-targets --message-format=json > clippy-report.json || true

      - name: Upload Clippy results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: clippy-report
          path: clippy-report.json
          retention-days: 7

      - name: Clippy summary
        if: failure()
        run: |
          echo "## Clippy Check Failed ‚ùå" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please fix all clippy warnings before merging." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Local Check Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cargo clippy --workspace --all-features --all-targets -- -D warnings" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Compilation Check - Must Pass
  # ============================================================================
  compile:
    name: Compilation Check
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            rust: stable
          - os: macos-latest
            target: x86_64-apple-darwin
            rust: stable
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            rust: stable

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
          override: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-build-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.target }}-
            ${{ runner.os }}-build-

      - name: Build workspace (debug)
        run: cargo build --workspace --all-features --verbose

      - name: Build workspace (release)
        run: cargo build --workspace --all-features --release --verbose

      - name: Check binary sizes
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "## Binary Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh target/release/*.bin 2>/dev/null || ls -lh target/release/vm* 2>/dev/null || echo "No binaries found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Test Suite - Must Pass
  # ============================================================================
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]
        include:
          - os: ubuntu-latest
            rust: nightly
            allow-failure: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}
          override: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-test-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-test-${{ matrix.rust }}-
            ${{ runner.os }}-test-

      - name: Run tests
        run: cargo test --workspace --all-features --verbose --no-fail-fast

      - name: Run tests (release mode)
        run: cargo test --workspace --all-features --release --verbose --no-fail-fast

      - name: Generate test results
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rust**: ${{ matrix.rust }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Documentation Check - Must Pass
  # ============================================================================
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rust-docs
          override: true

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-docs-${{ hashFiles('**/Cargo.lock') }}

      - name: Build documentation
        run: cargo doc --no-deps --workspace --all-features

      - name: Check for broken documentation links
        run: |
          echo "Checking for broken intra-doc links..."
          cargo doc --no-deps --workspace --all-features 2>&1 | \
            grep -i "broken\|cannot be resolved" && exit 1 || echo "‚úÖ No broken links"

      - name: Check undocumented public APIs
        run: |
          echo "Checking for undocumented public items..."
          cargo doc --no-deps --workspace --all-features 2>&1 | \
            grep "missing documentation" > /tmp/undocumented.txt || true

          if [ -s /tmp/undocumented.txt ]; then
            echo "‚ö†Ô∏è Found undocumented public items:"
            cat /tmp/undocumented.txt
            echo "Total: $(wc -l < /tmp/undocumented.txt) items"
            # Don't fail, just warn
          else
            echo "‚úÖ All public items are documented"
          fi

  # ============================================================================
  # Coverage Check - Minimum Threshold Enforced
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
          override: true

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-coverage-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate coverage report
        run: cargo llvm-cov --workspace --all-features --lcov --output-path lcov.info

      - name: Generate coverage summary
        run: cargo llvm-cov --workspace --all-features --summary --output-path coverage-summary.txt

      - name: Check coverage threshold
        run: |
          # Extract coverage percentage from summary
          if [ -f coverage-summary.txt ]; then
            COVERAGE=$(grep "TOTAL" coverage-summary.txt | awk '{print $NF}' | sed 's/%//')
            echo "Current coverage: ${COVERAGE}%"

            # Require at least 50% coverage
            THRESHOLD=50
            if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
              echo "‚ùå Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
              echo "## Coverage Below Threshold ‚ùå" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Current: **${COVERAGE}%** | Required: **${THRESHOLD}%**" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "‚úÖ Coverage ${COVERAGE}% meets threshold"
              echo "## Coverage Report ‚úÖ" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Current: **${COVERAGE}%** | Required: **${THRESHOLD}%**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è Could not parse coverage report"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            lcov.info
            coverage-summary.txt
          retention-days: 14

  # ============================================================================
  # Security Audit - Warnings Only
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-security-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit
        continue-on-error: true

      - name: Check license compliance
        run: |
          cargo install cargo-deny
          cargo deny check licenses
        continue-on-error: true

      - name: Check for duplicate dependencies
        run: |
          echo "Checking for duplicate dependencies..."
          cargo tree --duplicates --all-features || echo "No duplicates found"
        continue-on-error: true

  # ============================================================================
  # Unsafe Code Audit - Informational
  # ============================================================================
  unsafe-audit:
    name: Unsafe Code Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Count unsafe blocks
        run: |
          echo "## Unsafe Code Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Unsafe Blocks" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -r "unsafe" --include="*.rs" vm-*/src | wc -l | xargs echo "Total unsafe lines:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: List unsafe usage by crate
        run: |
          echo "### Unsafe Usage by Crate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Crate | Unsafe Lines |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------------|" >> $GITHUB_STEP_SUMMARY

          for dir in vm-*/; do
            if [ -d "${dir}src" ]; then
              count=$(grep -r "unsafe" --include="*.rs" "${dir}src" 2>/dev/null | wc -l | xargs)
              if [ "$count" -gt 0 ]; then
                echo "| ${dir%/} | $count |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

  # ============================================================================
  # Dependency Analysis
  # ============================================================================
  dependencies:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-deps-${{ hashFiles('**/Cargo.lock') }}

      - name: Analyze dependency tree
        run: |
          echo "## Dependency Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count direct dependencies
          DIRECT=$(grep -h "^name = " */Cargo.toml | wc -l)
          echo "- **Workspace Crates**: $DIRECT" >> $GITHUB_STEP_SUMMARY

          # Count total dependencies
          TOTAL=$(cargo tree --all-features | wc -l)
          echo "- **Total Dependencies**: $TOTAL" >> $GITHUB_STEP_SUMMARY

      - name: Check for outdated dependencies
        run: |
          cargo install cargo-outdated
          cargo outdated --workspace --exit-code 0
        continue-on-error: true

  # ============================================================================
  # Quality Gate Summary - Final Decision
  # ============================================================================
  quality-summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [format, clippy, compile, test, docs, coverage]
    if: always()

    steps:
      - name: Generate quality report
        run: |
          echo "# Quality Gates Report üö¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Gate Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status | Required |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.format.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} | Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy | ${{ needs.clippy.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} | Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Compile | ${{ needs.compile.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} | Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} | Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.docs.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} | Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result == 'success' && '‚úÖ Pass' || '‚ùå Fail' }} | Yes |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Determine overall status
        run: |
          # All required gates must pass
          if [ "${{ needs.format.result }}" == "success" ] && \
             [ "${{ needs.clippy.result }}" == "success" ] && \
             [ "${{ needs.compile.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.docs.result }}" == "success" ] && \
             [ "${{ needs.coverage.result }}" == "success" ]; then
            echo "## ‚úÖ All Quality Gates Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your changes meet all quality standards and are ready for merge." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "## ‚ùå Quality Gates Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the failing gates before merging." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the failed job logs" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix issues locally" >> $GITHUB_STEP_SUMMARY
            echo "3. Push changes to your branch" >> $GITHUB_STEP_SUMMARY
            echo "4. Wait for CI to re-run" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
