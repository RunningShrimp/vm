---
name: ⚡ 性能问题
about: 报告性能问题或提出性能优化建议
title: '[PERF] '
labels: performance
assignees: ''

---

## 📋 性能问题类型

请选择适用的问题类型（可多选）：

### 执行性能
- [ ] 🐌 **执行速度慢**（整体性能下降）
- [ ] ⏱️ **启动时间长**（VM初始化或JIT编译慢）
- [ ] 📉 **吞吐量低**（单位时间内处理少）
- [ ] 🔀 **延迟高**（单个操作响应慢）

### 资源使用
- [ ] 💾 **内存占用高**（内存使用过多）
- [ ] 🔥 **CPU占用高**（CPU使用率异常）
- [ ] 💧 **资源泄漏**（内存、文件描述符等）
- [ ] 📊 **内存增长**（内存持续增长不释放）

### 其他
- [ ] 🔍 **性能回归**（之前版本性能更好）
- [ ] 📈 **扩展性问题**（无法有效利用多核）
- [ ] 🎯 **特定场景问题**（某些工作负载性能差）
- [ ] 📝 **其他性能问题**（请在下方说明）

---

## 🖥️ 环境信息

**提供详细的环境信息，帮助复现和分析问题**

### 系统信息
- **操作系统**:
  - [ ] macOS (版本: __________)
  - [ ] Linux (发行版: __________)
  - [ ] Windows (版本: __________)
  - 其他: __________

- **CPU**:
  - 型号: __________
  - 核心数: __________
  - 频率: __________
  - 架构: x86_64 / ARM64 / RISC-V / 其他

- **内存**:
  - 总容量: __________
  - 可用内存: __________
  - 缓存信息: __________（如适用）

- **存储**:
  - 类型: SSD / HDD / NVMe
  - 文件系统: __________

### 软件信息
- **Rust版本**: `rustc --version` 输出: __________
- **Cargo版本**: `cargo --version` 输出: __________
- **VM版本**: __________（如 v0.2.0）
- **Git提交**: `git log -1 --format='%H'` 输出: __________

### 编译配置
- **编译模式**:
  - [ ] Debug
  - [ ] Release
  - [ ] Release with优化: `opt-level = ___`

- **Feature flags**:
  ```bash
  # 列出启用的features
  cargo build --verbose --features "..."
  ```

- **编译选项**:
  ```toml
  # Cargo.toml配置
  [profile.release]
  opt-level = ___
  lto = ___
  codegen-units = ___
  ```

### 运行配置
- **CPU配置**:
  - VCPU数量: __________
  - CPU亲和性: __________

- **内存配置**:
  - Guest内存大小: __________
  - MMU模式: __________

- **其他配置**:
  - JIT编译: 启用/禁用
  - 优化级别: __________
  - TLB大小: __________

---

## 🔁 复现场景

**详细描述如何复现性能问题**

### 复现步骤

**步骤1**: 配置环境
```bash
# 环境准备
git clone <repo>
cd vm
cargo build --release
```

**步骤2**: 运行测试
```bash
# 运行命令
cargo run --release --example quick_start
# 或
cargo bench --bench performance_test
```

**步骤3**: 观察问题
```
# 描述观察到的现象
- VM启动需要30秒
- 执行速度只有QEMU的50%
- 内存使用持续增长
```

### 复现代码

**如果适用，提供最小复现代码**：

```rust
// 提供可以复现性能问题的代码示例
use vm_core::*;
use vm_engine::*;

fn main() {
    // 配置VM
    let config = VmConfig {
        memory_size: 1024 * 1024 * 1024, // 1GB
        vcpu_count: 4,
        // ... 其他配置
    };

    // 运行工作负载
    let mut vm = VirtualMachine::new(config);

    // 这个操作特别慢
    for i in 0..10000 {
        vm.execute_instruction();
    }
}
```

### 工作负载描述

**描述典型的工作负载特征**：

- **指令集**:
  - [ ] RISC-V (RV64I/M/A/F/D/C)
  - [ ] x86_64
  - [ ] ARM64
  - 其他: __________

- **程序类型**:
  - [ ] 计算密集型（大量算术运算）
  - [ ] IO密集型（大量内存访问）
  - [ ] 分支密集型（大量条件跳转）
  - [ ] 系统调用密集型
  - 其他: __________

- **数据规模**:
  - [ ] 小程序 (< 1MB)
  - [ ] 中等 (1-100MB)
  - [ ] 大型 (> 100MB)

- **运行时长**:
  - [ ] 短期 (< 1秒)
  - [ ] 中期 (1-60秒)
  - [ ] 长期 (> 60秒)

---

## 📊 性能指标

**提供量化的性能数据**

### 当前性能

| 指标 | 当前值 | 测量方法 |
|------|--------|----------|
| 启动时间 | ________ ms | `time cargo run ...` |
| 执行速度 | ________ MIPS | 性能计数器 |
| 内存占用 | ________ MB | `/usr/bin/time -v` |
| 吞吐量 | ________ ops/s | 自定义基准 |
| 延迟 | ________ ns/ops | 基准测试 |
| JIT编译时间 | ________ ms | 日志输出 |

### 期望性能

| 指标 | 期望值 | 理由/参考 |
|------|--------|-----------|
| 启动时间 | < ________ ms | QEMU需要___ms |
| 执行速度 | > ________ MIPS | 原生执行___MIPS |
| 内存占用 | < ________ MB | 之前版本___MB |
| 吞吐量 | > ________ ops/s | 理论值___ops/s |
| 延迟 | < ________ ns/ops | 硬件延迟___ns |

### 性能差距

- **启动时间**: 慢了 ___% (当前___ms vs 期望___ms)
- **执行速度**: 慢了 ___倍 (当前___MIPS vs 期望___MIPS)
- **内存使用**: 高了 ___% (当前___MB vs 期望___MB)
- **其他**: __________

### 性能回归

**如果是性能回归，请提供**：

- **回归版本**: v0.X.Y → v0.Z.W
- **之前性能**: __________
- **当前性能**: __________
- **回归幅度**: ___%

---

## 🔬 Benchmark数据

**提供详细的基准测试数据**

### Criterion基准测试

```bash
# 运行基准测试
cargo bench --bench performance_test

# 保存基准结果
cargo bench --bench performance_test -- --save-baseline main

# 对比基准
cargo bench --bench performance_test -- --baseline main
```

**基准输出**：
```
粘贴Criterion输出结果

示例:
JIT compilation/Basic block
                        time:   [2.4567 ms 2.4789 ms 2.5034 ms]
                        change: [+5.234% +6.789% +8.123%] (p = 0.00 < 0.05)
                        Performance has regressed.
```

### 火焰图

**生成火焰图**：
```bash
# 安装flamegraph
cargo install flamegraph

# 生成火焰图
cargo flamegraph --bench performance_test -- --bench

# 输出文件
flamegraph.svg
```

**火焰图分析**：
```
描述火焰图中的关键发现：
- XX%时间花在函数YYY上
- 热点函数：AAA, BBB, CCC
```

### Profiling工具输出

**选择使用的profiling工具**：

- [ ] **Flamegraph** (`cargo-flamegraph`)
- [ ] **perf** (`perf record -g`)
- [ ] **Valgrind** (`valgrind --tool=callgrind`)
- [ ] **Heaptrack** (`heaptrack`)
- [ ] **DTrace** / **SystemTap**
- [ ] 其他: __________

**Profiling输出**：
```
粘贴profiling工具的输出或上传profile数据
```

---

## 🔍 分析和假设

**分享你的分析和想法**

### 可能的原因

**根据分析，可能的原因包括**：

1. **算法复杂度问题**
   - 描述: __________
   - 证据: __________

2. **锁竞争**
   - 描述: __________
   - 证据: __________

3. **内存分配**
   - 描述: __________
   - 证据: __________

4. **缓存未命中**
   - 描述: __________
   - 证据: __________

5. **JIT编译开销**
   - 描述: __________
   - 证据: __________

6. **其他**: __________

### 性能瓶颈位置

**指出可能的性能瓶颈**：

- **文件位置**: `vm-core/src/lib.rs:100-200`
- **函数名称**: `function_name`
- **代码路径**: JIT编译 → 寄存器分配 → 代码生成

### 已尝试的优化

**描述你已经尝试的优化方法**：

1. **优化尝试1**: __________
   - 结果: __________
   - 数据: 性能提升了 ___%

2. **优化尝试2**: __________
   - 结果: __________
   - 数据: 性能提升了 ___%

---

## 📈 性能对比

**与其他实现或参考系统的对比**

### 与其他VM对比

| 系统 | 启动时间 | 执行速度 | 内存使用 | 备注 |
|------|----------|----------|----------|------|
| 本项目 | ___ ms | ___ MIPS | ___ MB |  |
| QEMU | ___ ms | ___ MIPS | ___ MB | 参考值 |
| 其他VM | ___ ms | ___ MIPS | ___ MB |  |

### 与硬件对比

| 场景 | 虚拟机性能 | 硬件性能 | 比率 |
|------|------------|----------|------|
| 原生执行 | ___ MIPS | ___ MIPS | ___% |
| 特定工作负载 | ___ ops/s | ___ ops/s | ___% |

### 版本对比

| 版本 | 启动时间 | 执行速度 | 变化 |
|------|----------|----------|------|
| v0.1.0 | ___ ms | ___ MIPS | 基线 |
| v0.2.0 | ___ ms | ___ MIPS | ±___% |
| 当前 | ___ ms | ___ MIPS | ±___% |

---

## 🎯 优先级评估

### 严重程度

- [ ] 🔴 **P0 - 严重性能退化**
  - 性能下降 > 50%
  - 影响所有用户
  - 阻塞正常使用

- [ ] 🟡 **P1 - 重要性能瓶颈**
  - 性能下降 20-50%
  - 影响核心功能
  - 需要紧急关注

- [ ] 🟢 **P2 - 性能改进**
  - 性能下降 < 20%
  - 或性能提升机会
  - 可计划处理

- [ ] 🔵 **P3 - 优化建议**
  - 边缘优化
  - 长期改进项目

### 影响范围

- **用户影响**:
  - [ ] 所有用户
  - [ ] 特定平台（__________）
  - [ ] 特定工作负载（__________）

- **功能影响**:
  - [ ] 核心功能（VM执行）
  - [ ] JIT编译
  - [ ] 内存管理
  - [ ] 设备模拟

---

## 🔗 相关信息

### 相关Issue/PR
- 引用相关Issue: #123
- 引用相关PR: #456
- 性能回归引入的commit: __________

### 相关代码
- 可能的瓶颈位置: __________
- 相关模块: __________

### 参考资源
- 性能分析文档: __________
- 类似问题: __________
- 参考论文或文章: __________

---

## 🤝 愿意贡献

### 您希望如何帮助？

- [ ] 🚀 **我愿意帮助优化性能**
  - 预计完成时间: __________
  - 需要帮助的方面: __________

- [ ] 📊 **我愿意提供更多profiling数据**
  - 可运行的测试: __________

- [ ] 👀 **我愿意帮助审查性能优化PR**

- [ ] 🧪 **我愿意测试性能修复**
  - 测试平台: __________

- [ ] 🎓 **我有相关专业知识**
  - 领域: __________

---

## 📝 额外信息

添加任何其他有助于分析性能问题的信息：

### 额外的Profiling数据

- CPU profile: __________
- Memory profile: __________
- Heap profile: __________
- 其他: __________

### 附加说明

- 是否在特定条件下才会出现？
- 是否与特定配置相关？
- 是否有已知的工作绕过方法？
- 最近是否有相关变更？

### 附件

- [ ] 火焰图图片
- [ ] Profiling数据文件
- [ ] Benchmark输出文件
- [ ] 复现代码
- [ ] 测试工作负载

---

**提交前检查清单**:
- [ ] 已提供详细的环境信息
- [ ] 已描述复现步骤
- [ ] 已提供量化的性能数据
- [ ] 已提供benchmark或profiling数据
- [ ] 已分析可能的原因
- [ ] 已评估优先级

感谢报告性能问题！⚡

性能优化是VM项目的核心目标，每一个性能报告都很有价值。我们会认真分析和处理所有性能问题。
