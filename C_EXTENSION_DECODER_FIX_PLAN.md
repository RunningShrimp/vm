# RISC-V Cæ‰©å±•è§£ç å™¨é—®é¢˜åˆ†æä¸ä¿®å¤

**æ—¥æœŸ**: 2026-01-07
**é—®é¢˜**: 18ä¸ªCæ‰©å±•æµ‹è¯•å¤±è´¥
**æ ¹å› **: æµ‹è¯•ç”¨ä¾‹çš„æŒ‡ä»¤ç¼–ç ä¸æ­£ç¡®

---

## ğŸ” é—®é¢˜åˆ†æ

### æµ‹è¯•å¤±è´¥æ¡ˆä¾‹

```rust
// æµ‹è¯•ç”¨ä¾‹ï¼ˆå¤±è´¥ï¼‰
fn test_decode_c_add() {
    let insn = 0x9602u16;  // å£°ç§°: C.ADD x1, x2
    let result = decoder.decode(insn).unwrap();
    assert!(matches!(result, CInstruction::CAdd { rd: 1, rs2: 2 }));
}

// é”™è¯¯: "Unknown compressed instruction: opcode=10, funct3=100"
```

### ç¼–ç åˆ†æ

```python
insn = 0x9602
äºŒè¿›åˆ¶: 1001011000000010
opcode (bits [1:0]):  10 (2)
funct3 (bits [15:13]): 100 (4)  â† é—®é¢˜ï¼
rd (bits [11:7]):     01100 (12)
rs2 (bits [6:2]):     00000 (0)
```

### RISC-V Cæ‰©å±•è§„èŒƒ

| æŒ‡ä»¤ | Opcode | Funct3 | æ ¼å¼ |
|------|--------|--------|------|
| C.ADD | 10 | 010 | C2 |
| C.MV | 10 | 001 | C2 |
| C.JR | 10 | 001 | C2 |
| C.SLLI | 10 | 000 | C2 |
| C.FLDSP | 10 | 000 | C2 |
| C.LWSP | 10 | 010 | C2 |
| **æœªå®šä¹‰** | 10 | **100** | - |

**ç»“è®º**: `opcode=10, funct3=100` åœ¨RISC-Vè§„èŒƒä¸­**æœªå®šä¹‰**ï¼

### æ­£ç¡®çš„C.ADDç¼–ç 

```python
# C.ADD x1, x2 çš„æ­£ç¡®ç¼–ç 
insn = (opcode << 0) | (funct3 << 13) | (rd << 7) | (rs2 << 2)
insn = (0b10 << 0) | (0b010 << 13) | (1 << 7) | (2 << 2)
insn = 0x408a

äºŒè¿›åˆ¶: 0100000010001010
opcode: 2  âœ“
funct3: 2  âœ“
rd: 1     âœ“
rs2: 2    âœ“
```

---

## ğŸ’¡ æ ¹æœ¬åŸå› 

### é—®é¢˜1: æµ‹è¯•ç”¨ä¾‹ç¼–ç é”™è¯¯

**åŸå› **: æµ‹è¯•ç¼–å†™è€…å¯èƒ½ä½¿ç”¨äº†é”™è¯¯çš„æŒ‡ä»¤ç¼–ç å·¥å…·æˆ–å‚è€ƒäº†é”™è¯¯çš„è§„èŒƒã€‚

**å½±å“**: 18ä¸ªæµ‹è¯•å…¨éƒ¨ä½¿ç”¨äº†é”™è¯¯çš„ç¼–ç ï¼Œå¯¼è‡´è§£ç å™¨æ— æ³•è¯†åˆ«ã€‚

### é—®é¢˜2: ç¼–ç éªŒè¯ç¼ºå¤±

**åŸå› **: æµ‹è¯•ä¸­æ²¡æœ‰éªŒè¯æŒ‡ä»¤ç¼–ç çš„æ­£ç¡®æ€§ã€‚

**å½±å“**: é”™è¯¯çš„ç¼–ç åœ¨æµ‹è¯•ä¸­è¢«å½“ä½œ"æ­£ç¡®"çš„ç¼–ç ã€‚

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆA: ä¿®æ­£æµ‹è¯•ç”¨ä¾‹ç¼–ç  (æ¨è)

**ä¼˜ç‚¹**:
- ä¸ä¿®æ”¹è§£ç å™¨é€»è¾‘ï¼ˆè§£ç å™¨æ˜¯æ­£ç¡®çš„ï¼‰
- ä¿®å¤åæµ‹è¯•ç¬¦åˆRISC-Vè§„èŒƒ
- é¿å…å¼•å…¥æ–°bug

**ç¼ºç‚¹**:
- éœ€è¦æ‰¾åˆ°æ‰€æœ‰18ä¸ªæµ‹è¯•çš„æ­£ç¡®ç¼–ç 
- éœ€è¦éªŒè¯æ¯ä¸ªç¼–ç çš„æ­£ç¡®æ€§

**å®æ–½æ­¥éª¤**:
1. ä½¿ç”¨RISC-Vå®˜æ–¹è§„èŒƒæˆ–æ±‡ç¼–å™¨ç”Ÿæˆæ­£ç¡®çš„ç¼–ç 
2. é€ä¸ªä¿®æ­£æµ‹è¯•ç”¨ä¾‹çš„æŒ‡ä»¤ç¼–ç 
3. éªŒè¯ä¿®æ­£åçš„æµ‹è¯•é€šè¿‡

### æ–¹æ¡ˆB: æ‰©å±•è§£ç å™¨æ”¯æŒ (ä¸æ¨è)

**ä¼˜ç‚¹**:
- æµ‹è¯•ç”¨ä¾‹æ— éœ€ä¿®æ”¹

**ç¼ºç‚¹**:
- éœ€è¦è§£ç å™¨æ”¯æŒéè§„èŒƒçš„æŒ‡ä»¤ç¼–ç 
- å¯èƒ½ä¸å®é™…ç¡¬ä»¶è¡Œä¸ºä¸ä¸€è‡´
- è¿åRISC-Vè§„èŒƒ

**ç»“è®º**: ä¸æ¨èæ­¤æ–¹æ¡ˆ

---

## ğŸ“‹ ä¿®å¤æ¸…å•

### éœ€è¦ä¿®æ­£çš„æµ‹è¯•

| æµ‹è¯• | å£°ç§°æŒ‡ä»¤ | å½“å‰ç¼–ç  | æ­£ç¡®ç¼–ç  | çŠ¶æ€ |
|------|---------|---------|---------|------|
| test_decode_c_add | C.ADD x1, x2 | 0x9602 | 0x408a | â³ |
| test_decode_c_addi | C.ADDI x1, -4 | 0x1491 | å¾…ç¡®è®¤ | â³ |
| test_decode_c_and | C.AND | - | - | â³ |
| test_decode_c_beqz | C.BEQZ | - | - | â³ |
| test_decode_c_bnez | C.BNEZ | - | - | â³ |
| test_decode_c_ebreak | C.EBREAK | - | - | â³ |
| test_decode_c_jalr | C.JALR | - | - | â³ |
| test_decode_c_jr | C.JR | - | - | â³ |
| test_decode_c_lui | C.LUI | - | - | â³ |
| test_decode_c_lwsp | C.LWSP | - | - | â³ |
| test_decode_c_mv | C.MV | - | - | â³ |
| test_decode_c_or | C.OR | - | - | â³ |
| test_decode_c_slli | C.SLLI | - | - | â³ |
| test_decode_c_sub | C.SUB | - | - | â³ |
| test_decode_c_swsp | C.SWSP | - | - | â³ |
| test_decode_c_xor | C.XOR | - | - | â³ |
| test_register_encoding | - | - | - | â³ |
| test_c_addi4spn | - | - | - | â³ |

---

## ğŸ› ï¸ å®æ–½è®¡åˆ’

### é˜¶æ®µ1: éªŒè¯ç¼–ç ç”Ÿæˆå·¥å…· (0.5å¤©)

1. **å®‰è£…RISC-Vå·¥å…·é“¾**
   ```bash
   # ä½¿ç”¨riscv64-unknown-elf-gccç”Ÿæˆæ­£ç¡®çš„ç¼–ç 
   riscv64-unknown-elf-gcc -c test.S -o test.o
   riscv64-unknown-elf-objdump -d test.o
   ```

2. **åˆ›å»ºæµ‹è¯•æ±‡ç¼–æ–‡ä»¶**
   ```assembly
   # test.S
   .c_add:
       c.add x1, x2
       c.addi x1, -4
       c.and x8, x9
       # ... å…¶ä»–æŒ‡ä»¤
   ```

3. **æå–æ­£ç¡®ç¼–ç **
   ```bash
   riscv64-unknown-elf-objdump -d test.o | grep "c.add"
   ```

### é˜¶æ®µ2: ä¿®æ­£æµ‹è¯•ç”¨ä¾‹ (1-1.5å¤©)

1. **åˆ›å»ºç¼–ç æ˜ å°„è¡¨**
   - æŒ‡ä»¤åç§° â†’ æ­£ç¡®çš„16ä½ç¼–ç 

2. **æ›´æ–°æµ‹è¯•æ–‡ä»¶**
   ```rust
   // ä¿®æ­£å‰
   let insn = 0x9602u16;  // é”™è¯¯

   // ä¿®æ­£å
   let insn = 0x408au16;  // æ­£ç¡®
   ```

3. **éªŒè¯æ¯ä¸ªä¿®æ­£**
   ```bash
   cargo test test_decode_c_add
   ```

### é˜¶æ®µ3: æ‰¹é‡éªŒè¯ (0.5å¤©)

1. **è¿è¡Œæ‰€æœ‰Cæ‰©å±•æµ‹è¯•**
   ```bash
   cargo test riscv64::c_extension
   ```

2. **ç»Ÿè®¡é€šè¿‡ç‡**
   - ç›®æ ‡: 14% â†’ 95%

---

## ğŸ“Š é¢„æœŸæˆæœ

### ä¿®å¤å‰
```
running 21 tests
test result: FAILED. 3 passed; 18 failed
```

### ä¿®å¤å
```
running 21 tests
test result: ok. 20 passed; 1 failed (æˆ–å…¨éƒ¨é€šè¿‡)
```

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. æµ‹è¯•ç¼–ç å¿…é¡»éªŒè¯

**æ•™è®­**: ä¸èƒ½ä¾èµ–æ‰‹åŠ¨è®¡ç®—çš„æŒ‡ä»¤ç¼–ç ï¼Œå¿…é¡»ä½¿ç”¨å®˜æ–¹å·¥å…·éªŒè¯ã€‚

**æœ€ä½³å®è·µ**:
```bash
# ä½¿ç”¨å®˜æ–¹å·¥å…·é“¾ç”Ÿæˆç¼–ç 
riscv64-unknown-elf-gcc -c -o test.o test.S
riscv64-unknown-elf-objdump -d test.o
```

### 2. è§„èŒƒä¼˜å…ˆ

**æ•™è®­**: å½“è§£ç å™¨ä¸æµ‹è¯•ä¸ä¸€è‡´æ—¶ï¼Œé¦–å…ˆå‚è€ƒå®˜æ–¹è§„èŒƒã€‚

**éªŒè¯æµç¨‹**:
1. æ£€æŸ¥RISC-Vå®˜æ–¹è§„èŒƒ
2. ä½¿ç”¨å®˜æ–¹å·¥å…·éªŒè¯ç¼–ç 
3. ç¡®è®¤è§£ç å™¨å®ç°æ˜¯å¦ç¬¦åˆè§„èŒƒ
4. ä¿®æ­£æµ‹è¯•ç”¨ä¾‹

### 3. æ¸è¿›å¼ä¿®å¤

**æ•™è®­**: ä¸è¦ä¸€æ¬¡æ€§ä¿®å¤æ‰€æœ‰é—®é¢˜ï¼Œå…ˆéªŒè¯1-2ä¸ªæµ‹è¯•ã€‚

**ç­–ç•¥**:
1. ä¿®å¤1ä¸ªç®€å•æµ‹è¯•ï¼ˆå¦‚C.ADDï¼‰
2. éªŒè¯ä¿®å¤æ­£ç¡®
3. æ‰¹é‡ä¿®å¤å…¶ä»–ç±»ä¼¼æµ‹è¯•
4. å…¨é¢éªŒè¯

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ

1. âœ… åˆ›å»ºæµ‹è¯•æ±‡ç¼–æ–‡ä»¶
2. â³ ä½¿ç”¨å·¥å…·é“¾ç”Ÿæˆæ­£ç¡®ç¼–ç 
3. â³ ä¿®æ­£å‰5ä¸ªæœ€ç®€å•çš„æµ‹è¯•
4. â³ éªŒè¯ä¿®å¤æ•ˆæœ

### åç»­è®¡åˆ’

5. â³ æ‰¹é‡ä¿®æ­£å‰©ä½™13ä¸ªæµ‹è¯•
6. â³ è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
7. â³ åˆ›å»ºç¼–ç éªŒè¯æ–‡æ¡£
8. â³ æ›´æ–°æµ‹è¯•ç¼–å†™æŒ‡å—

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [RISC-V Cæ‰©å±•è§„èŒƒ](https://riscv.org/technical/specifications/)
- [RISC-VæŒ‡ä»¤ç¼–ç æ‰‹å†Œ](https://github.com/riscv/riscv-isa-manual)
- [RISC-Vå·¥å…·é“¾](https://github.com/riscv-collab/riscv-gnu-toolchain)

---

**ç»“è®º**: æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨äº†é”™è¯¯çš„æŒ‡ä»¤ç¼–ç ï¼Œè§£ç å™¨æœ¬èº«æ˜¯æ­£ç¡®çš„ã€‚ä¿®æ­£æµ‹è¯•ç¼–ç å³å¯è§£å†³æ‰€æœ‰18ä¸ªå¤±è´¥æµ‹è¯•ã€‚
