# Rust è™šæ‹Ÿæœºè½¯ä»¶æ¶æ„å®¡æŸ¥æŠ¥å‘Š

**é¡¹ç›®åç§°**: VM - é«˜æ€§èƒ½è·¨å¹³å°è™šæ‹Ÿæœº  
**å®¡æŸ¥æ—¥æœŸ**: 2025å¹´11æœˆ28æ—¥  
**ç‰ˆæœ¬**: 0.1.0  

---

## ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#1-æ‰§è¡Œæ‘˜è¦)
2. [æ¶æ„åˆ†æ](#2-æ¶æ„åˆ†æ)
3. [åŠŸèƒ½å®Œæ•´æ€§è¯„ä¼°](#3-åŠŸèƒ½å®Œæ•´æ€§è¯„ä¼°)
4. [æ€§èƒ½ä¼˜åŒ–è¯†åˆ«](#4-æ€§èƒ½ä¼˜åŒ–è¯†åˆ«)
5. [å¯ç»´æŠ¤æ€§æ£€æŸ¥](#5-å¯ç»´æŠ¤æ€§æ£€æŸ¥)
6. [DDD åˆè§„æ€§éªŒè¯](#6-ddd-åˆè§„æ€§éªŒè¯)
7. [å…³é”®é—®é¢˜ä¸å»ºè®®æ±‡æ€»](#7-å…³é”®é—®é¢˜ä¸å»ºè®®æ±‡æ€»)
8. [é™„å½•](#8-é™„å½•)
9. [é‡å¤å®ç°é—®é¢˜åˆ†æ](#9-é‡å¤å®ç°é—®é¢˜åˆ†æ)
10. [æ€»ç»“ä¸è¡ŒåŠ¨é¡¹](#10-æ€»ç»“ä¸è¡ŒåŠ¨é¡¹)

---

## 1. æ‰§è¡Œæ‘˜è¦

### 1.1 é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªç”¨ Rust å¼€å‘çš„é«˜æ€§èƒ½è·¨å¹³å°è™šæ‹Ÿæœºè½¯ä»¶ï¼Œæ”¯æŒå¤šç§ Guest æ¶æ„ï¼ˆRISC-V64ã€ARM64ã€x86_64ï¼‰å’Œå¤šç§æ‰§è¡Œæ¨¡å¼ï¼ˆè§£é‡Šå™¨ã€JITã€ç¡¬ä»¶åŠ é€Ÿï¼‰ã€‚é¡¹ç›®é‡‡ç”¨ Workspace ç»“æ„ï¼ŒåŒ…å« 18 ä¸ªæ¨¡å—ï¼Œè¦†ç›–æ ¸å¿ƒæ‰§è¡Œã€å†…å­˜ç®¡ç†ã€è®¾å¤‡è™šæ‹ŸåŒ–ã€å‰ç«¯è§£ç ç­‰åŠŸèƒ½ã€‚

### 1.2 å®¡æŸ¥ç»“è®º

| ç»´åº¦ | è¯„åˆ† | çŠ¶æ€ |
|------|------|------|
| æ¶æ„è®¾è®¡ | â˜…â˜…â˜…â˜…â˜† | è‰¯å¥½ |
| åŠŸèƒ½å®Œæ•´æ€§ | â˜…â˜…â˜…â˜…â˜† | è‰¯å¥½ |
| æ€§èƒ½ä¼˜åŒ– | â˜…â˜…â˜…â˜†â˜† | ä¸­ç­‰ |
| å¯ç»´æŠ¤æ€§ | â˜…â˜…â˜…â˜…â˜† | è‰¯å¥½ |
| DDD åˆè§„æ€§ | â˜…â˜…â˜…â˜…â˜… | ä¼˜ç§€ |

### 1.3 ä¸»è¦å‘ç°

**ä¼˜åŠ¿**:
- æ¸…æ™°çš„æ¨¡å—åŒ–æ¶æ„ï¼ŒèŒè´£åˆ†ç¦»æ˜ç¡®
- å®Œå–„çš„è·¨å¹³å°ç¡¬ä»¶åŠ é€Ÿæ”¯æŒ (KVM/HVF/WHPX)
- è‰¯å¥½çš„ DDD è´«è¡€æ¨¡å‹å®è·µ
- ä¸°å¯Œçš„æ–‡æ¡£æ³¨é‡Šå’Œç¤ºä¾‹ä»£ç 

**å¾…æ”¹è¿›**:
- éƒ¨åˆ†å¼‚æ­¥ä»£ç å¯è¿›ä¸€æ­¥ä¼˜åŒ–
- æµ‹è¯•è¦†ç›–ç‡æœ‰æå‡ç©ºé—´
- æŸäº›æ¨¡å—é—´è€¦åˆåº¦å¯é™ä½

---

## 2. æ¶æ„åˆ†æ

### 2.1 æ¨¡å—ç»“æ„

```
vm (workspace)
â”œâ”€â”€ vm-core          # æ ¸å¿ƒç±»å‹å®šä¹‰ä¸ Trait æŠ½è±¡
â”œâ”€â”€ vm-ir            # ä¸­é—´è¡¨ç¤ºå±‚ (IR)
â”œâ”€â”€ vm-mem           # å†…å­˜ç®¡ç†å•å…ƒ (MMU/TLB)
â”œâ”€â”€ vm-accel         # ç¡¬ä»¶è™šæ‹ŸåŒ–åŠ é€Ÿå±‚
â”œâ”€â”€ vm-device        # è®¾å¤‡è™šæ‹ŸåŒ–
â”œâ”€â”€ vm-frontend-*    # å‰ç«¯è§£ç å™¨ (x86_64/ARM64/RISC-V64)
â”œâ”€â”€ vm-engine-*      # æ‰§è¡Œå¼•æ“ (è§£é‡Šå™¨/JIT/æ··åˆ)
â”œâ”€â”€ vm-simd          # SIMD å‘é‡è¿ç®—åº“
â”œâ”€â”€ vm-osal          # æ“ä½œç³»ç»ŸæŠ½è±¡å±‚
â”œâ”€â”€ vm-passthrough   # ç¡¬ä»¶ç›´é€š
â”œâ”€â”€ vm-boot          # å¯åŠ¨æ¡†æ¶
â”œâ”€â”€ vm-service       # æœåŠ¡å±‚
â”œâ”€â”€ vm-cli           # å‘½ä»¤è¡Œæ¥å£
â””â”€â”€ vm-tests         # æµ‹è¯•å¥—ä»¶
```

### 2.2 æ¶æ„è¯„ä¼°

#### 2.2.1 åˆ†å±‚æ¶æ„

é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼š

| å±‚çº§ | æ¨¡å— | èŒè´£ |
|------|------|------|
| **æ¥å£å±‚** | `vm-cli`, `vm-service` | ç”¨æˆ·äº¤äº’ã€æœåŠ¡ç¼–æ’ |
| **æ‰§è¡Œå±‚** | `vm-engine-*`, `vm-accel` | ä»£ç æ‰§è¡Œã€ç¡¬ä»¶åŠ é€Ÿ |
| **ç¿»è¯‘å±‚** | `vm-frontend-*`, `vm-ir` | æŒ‡ä»¤è§£ç ã€IR ç”Ÿæˆ |
| **èµ„æºå±‚** | `vm-mem`, `vm-device` | å†…å­˜ç®¡ç†ã€è®¾å¤‡è™šæ‹ŸåŒ– |
| **åŸºç¡€å±‚** | `vm-core`, `vm-osal`, `vm-simd` | æ ¸å¿ƒæŠ½è±¡ã€å¹³å°é€‚é… |

**è¯„ä»·**: âœ… åˆ†å±‚æ¸…æ™°ï¼Œä¾èµ–æ–¹å‘æ­£ç¡®ï¼ˆä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼‰

#### 2.2.2 è·¨å¹³å°è®¾è®¡

```rust
// vm-accel/src/lib.rs - å¹³å°æŠ½è±¡ç¤ºä¾‹
pub fn select() -> (AccelKind, Box<dyn Accel>) {
    #[cfg(target_os = "linux")]
    { let mut a = kvm_impl::AccelKvm::new(); ... }
    #[cfg(target_os = "macos")]
    { let mut a = hvf_impl::AccelHvf::new(); ... }
    #[cfg(target_os = "windows")]
    { let mut a = whpx_impl::AccelWhpx::new(); ... }
}
```

| å¹³å° | åç«¯ | çŠ¶æ€ |
|------|------|------|
| Linux | KVM | âœ… å®Œæ•´æ”¯æŒ |
| macOS | Hypervisor.framework | âœ… å®Œæ•´æ”¯æŒ |
| Windows | WHPX | âœ… å®Œæ•´æ”¯æŒ |
| iOS/tvOS | Virtualization.framework | âš ï¸ å®éªŒæ€§ |
| HarmonyOS | æ£€æµ‹æ”¯æŒ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |

**è¯„ä»·**: âœ… è·¨å¹³å°è®¾è®¡å®Œå–„ï¼Œé€šè¿‡æ¡ä»¶ç¼–è¯‘å’Œ Trait æŠ½è±¡å®ç°å¹³å°æ— å…³

#### 2.2.3 è®¾è®¡æ¨¡å¼åº”ç”¨

| æ¨¡å¼ | åº”ç”¨ä½ç½® | è¯´æ˜ |
|------|----------|------|
| **ç­–ç•¥æ¨¡å¼** | `ExecutionEngine` trait | å¯åˆ‡æ¢çš„æ‰§è¡Œå¼•æ“ |
| **å·¥å‚æ¨¡å¼** | `select()` å‡½æ•° | è‡ªåŠ¨é€‰æ‹©æœ€ä½³åŠ é€Ÿå™¨ |
| **é€‚é…å™¨æ¨¡å¼** | `MmioDevice` trait | ç»Ÿä¸€è®¾å¤‡æ¥å£ |
| **è§‚å¯Ÿè€…æ¨¡å¼** | `RuntimeEvent` | è¿è¡Œæ—¶äº‹ä»¶é€šçŸ¥ |
| **å»ºé€ è€…æ¨¡å¼** | `BootConfig`, `IRBuilder` | é…ç½®å’Œ IR æ„å»º |

### 2.3 æ¶æ„é—®é¢˜ä¸å»ºè®®

#### é—®é¢˜ 1: æ¨¡å—é—´å¾ªç¯ä¾èµ–é£é™©

**ç°çŠ¶**: `vm-service` ç›´æ¥ä¾èµ–å…·ä½“å®ç°ï¼ˆå¦‚ `RiscvDecoder`ï¼‰

**å»ºè®®**: å¼•å…¥ä¾èµ–æ³¨å…¥ï¼Œé€šè¿‡ Trait å¯¹è±¡è§£è€¦

```rust
// å½“å‰
let decoder = Box::new(RiscvDecoder);

// å»ºè®®
pub trait DecoderFactory: Send + Sync {
    fn create(&self, arch: GuestArch) -> Box<dyn Decoder<Block = IRBlock>>;
}
```

#### é—®é¢˜ 2: é…ç½®åˆ†æ•£

**ç°çŠ¶**: é…ç½®æ•£è½åœ¨å¤šä¸ªç»“æ„ä½“ä¸­ (`VmConfig`, `BootConfig`, `AsyncIoConfig`)

**å»ºè®®**: ç»Ÿä¸€é…ç½®ç®¡ç†

```rust
pub struct VmConfiguration {
    pub core: VmConfig,
    pub boot: BootConfig,
    pub io: AsyncIoConfig,
    pub accel: AccelConfig,
}
```

---

## 3. åŠŸèƒ½å®Œæ•´æ€§è¯„ä¼°

### 3.1 æ ¸å¿ƒåŠŸèƒ½çŸ©é˜µ

| åŠŸèƒ½æ¨¡å— | åŠŸèƒ½ç‚¹ | çŠ¶æ€ | å®Œæˆåº¦ |
|----------|--------|------|--------|
| **CPU è™šæ‹ŸåŒ–** | å¯„å­˜å™¨ç®¡ç† | âœ… | 100% |
| | æŒ‡ä»¤è§£ç  (RISC-V) | âœ… | 95% |
| | æŒ‡ä»¤è§£ç  (ARM64) | âœ… | 85% |
| | æŒ‡ä»¤è§£ç  (x86_64) | âœ… | 80% |
| | ä¸­æ–­å¤„ç† | âœ… | 90% |
| **å†…å­˜ç®¡ç†** | è½¯ä»¶ MMU | âœ… | 100% |
| | TLB ç¼“å­˜ | âœ… | 100% |
| | SV39/SV48 é¡µè¡¨ | âœ… | 100% |
| | å¤§é¡µæ”¯æŒ | âœ… | 90% |
| **æ‰§è¡Œå¼•æ“** | è§£é‡Šå™¨ | âœ… | 100% |
| | JIT ç¼–è¯‘ | âœ… | 85% |
| | æ··åˆæ‰§è¡Œ | âœ… | 90% |
| | ç¡¬ä»¶åŠ é€Ÿ | âœ… | 95% |
| **è®¾å¤‡è™šæ‹ŸåŒ–** | VirtIO Block | âœ… | 95% |
| | VirtIO Net | âœ… | 85% |
| | CLINT/PLIC | âœ… | 100% |
| | GPU è™šæ‹ŸåŒ– | âš ï¸ | 70% |
| **ç³»ç»ŸåŠŸèƒ½** | å¿«ç…§/æ¢å¤ | âœ… | 90% |
| | å®æ—¶è¿ç§» | âœ… | 80% |
| | GDB è°ƒè¯• | âœ… | 85% |
| | çƒ­æ’æ‹” | âœ… | 75% |

### 3.2 åŠŸèƒ½è¯¦ç»†è¯„ä¼°

#### 3.2.1 CPU è™šæ‹ŸåŒ–

**RISC-V 64 æ”¯æŒ** (vm-frontend-riscv64)

```rust
// æ”¯æŒçš„æŒ‡ä»¤ç±»å‹
- RV64I: åŸºç¡€æ•´æ•°æŒ‡ä»¤ âœ…
- RV64M: ä¹˜é™¤æ³•æ‰©å±• âœ…
- RV64A: åŸå­æ“ä½œæ‰©å±• âœ…
- RV64F/D: æµ®ç‚¹æ‰©å±• âš ï¸ éƒ¨åˆ†
- RV64C: å‹ç¼©æŒ‡ä»¤ âŒ å¾…å®ç°
```

**ARM64 æ”¯æŒ** (vm-frontend-arm64)

```rust
// æ”¯æŒçš„æŒ‡ä»¤ç±»å‹
- æ•°æ®å¤„ç†æŒ‡ä»¤ âœ…
- åŠ è½½/å­˜å‚¨æŒ‡ä»¤ âœ…
- åˆ†æ”¯æŒ‡ä»¤ âœ…
- SIMD/FP æŒ‡ä»¤ âš ï¸ éƒ¨åˆ†
- ç³»ç»ŸæŒ‡ä»¤ âš ï¸ éƒ¨åˆ†
```

**x86_64 æ”¯æŒ** (vm-frontend-x86_64)

```rust
// æ”¯æŒçš„æŒ‡ä»¤ç±»å‹
- åŸºç¡€ ALU æŒ‡ä»¤ âœ…
- æ§åˆ¶æµæŒ‡ä»¤ âœ…
- SSE æŒ‡ä»¤ âš ï¸ éƒ¨åˆ†
- ç³»ç»Ÿè°ƒç”¨ âœ…
```

#### 3.2.2 IR ä¸­é—´è¡¨ç¤º

```rust
// vm-ir æ”¯æŒçš„æ“ä½œç±»å‹
pub enum IROp {
    // ç®—æœ¯/é€»è¾‘ (å®Œæ•´)
    Add, Sub, Mul, Div, Rem, And, Or, Xor, Not, ...
    
    // ç§»ä½æ“ä½œ (å®Œæ•´)
    Sll, Srl, Sra, SllImm, SrlImm, SraImm, ...
    
    // æ¯”è¾ƒæ“ä½œ (å®Œæ•´)
    CmpEq, CmpNe, CmpLt, CmpGe, ...
    
    // å†…å­˜æ“ä½œ (å®Œæ•´)
    Load, Store, AtomicRMW, AtomicCmpXchg, ...
    
    // SIMD æ“ä½œ (å®Œæ•´)
    VecAdd, VecSub, VecMul, Vec128Add, Vec256Add, ...
    
    // æµ®ç‚¹æ“ä½œ (å®Œæ•´)
    Fadd, Fsub, Fmul, Fdiv, Fsqrt, Fmadd, ...
}
```

**è¯„ä»·**: âœ… IR è®¾è®¡å…¨é¢ï¼Œè¦†ç›–æ‰€æœ‰ä¸»è¦æ“ä½œç±»å‹

#### 3.2.3 å†…å­˜ç®¡ç†

```rust
// vm-mem æ ¸å¿ƒåŠŸèƒ½
pub struct SoftMmu {
    phys_mem: Arc<PhysicalMemory>,  // å…±äº«ç‰©ç†å†…å­˜
    itlb: Tlb,                       // æŒ‡ä»¤ TLB (64 æ¡ç›®)
    dtlb: Tlb,                       // æ•°æ® TLB (128 æ¡ç›®)
    paging_mode: PagingMode,         // Bare/SV39/SV48/ARM64/x86_64
    // ...
}
```

**TLB å®ç°äº®ç‚¹**:
- HashMap + LRU å®ç° O(1) æŸ¥æ‰¾
- æ”¯æŒå…¨å±€é¡µå’Œ ASID éš”ç¦»
- ç‹¬ç«‹çš„æŒ‡ä»¤/æ•°æ® TLB

#### 3.2.4 è®¾å¤‡è™šæ‹ŸåŒ–

| è®¾å¤‡ç±»å‹ | å®ç° | åŠŸèƒ½ |
|----------|------|------|
| VirtIO Block | `VirtioBlock`, `VirtioBlockMmio` | è¯»/å†™/åˆ·æ–°ï¼Œå¼‚æ­¥ IO |
| VirtIO Net | `vhost_net` | ç½‘ç»œè™šæ‹ŸåŒ– |
| CLINT | `Clint`, `ClintMmio` | å®šæ—¶å™¨ä¸­æ–­ |
| PLIC | `Plic`, `PlicMmio` | å¤–éƒ¨ä¸­æ–­æ§åˆ¶ |
| GPU | `GpuManager`, `gpu_virt` | GPU è™šæ‹ŸåŒ–ç®¡ç† |
| VirtIO AI | `VirtioAi` | AI åŠ é€Ÿè®¾å¤‡ |

### 3.3 åŠŸèƒ½ç¼ºå¤±ä¸å»ºè®®

| ç¼ºå¤±åŠŸèƒ½ | ä¼˜å…ˆçº§ | å»ºè®® |
|----------|--------|------|
| RISC-V C æ‰©å±• | é«˜ | æ·»åŠ  16 ä½å‹ç¼©æŒ‡ä»¤æ”¯æŒ |
| å®Œæ•´ SSE/AVX | ä¸­ | æ‰©å±• x86 SIMD æŒ‡ä»¤é›† |
| VirtIO Console | ä¸­ | æ·»åŠ æ§åˆ¶å°è®¾å¤‡ |
| ç½‘ç»œ TAP åç«¯ | ä¸­ | å®ç°çœŸå®ç½‘ç»œæ¡¥æ¥ |
| UEFI å¯åŠ¨ | ä½ | å®Œå–„å›ºä»¶åŠ è½½ |

---

## 4. æ€§èƒ½ä¼˜åŒ–è¯†åˆ«

### 4.1 å½“å‰ä¼˜åŒ–æªæ–½

#### 4.1.1 å†…å­˜ç®¡ç†ä¼˜åŒ–

```rust
// TLB ä¼˜åŒ– - O(1) æŸ¥æ‰¾
struct Tlb {
    entries: HashMap<u64, TlbEntry>,      // ä¸»å“ˆå¸Œè¡¨
    lru: LruCache<u64, ()>,                // LRU æ›¿æ¢ç­–ç•¥
    global_entries: HashMap<u64, TlbEntry>, // å…¨å±€é¡µå•ç‹¬å­˜å‚¨
}

// å¤§é¡µæ”¯æŒ
pub struct HugePageAllocator {
    enabled: bool,
    page_size: HugePageSize,  // 2M / 1G
}
```

**è¯„ä»·**: âœ… TLB å®ç°é«˜æ•ˆï¼Œæ”¯æŒå¤§é¡µåˆ†é…

#### 4.1.2 JIT ç¼–è¯‘ä¼˜åŒ–

```rust
// è‡ªé€‚åº”çƒ­ç‚¹é˜ˆå€¼
pub struct AdaptiveThreshold {
    current_threshold: u64,           // åŠ¨æ€è°ƒæ•´
    compile_time_samples: Vec<u64>,   // ç¼–è¯‘æ—¶é—´é‡‡æ ·
    exec_benefit_samples: Vec<i64>,   // æ‰§è¡Œæ”¶ç›Šé‡‡æ ·
}

// è°ƒæ•´ç­–ç•¥
// - é«˜ç¼–è¯‘æ—¶é—´ + ä½æ”¶ç›Š -> æé«˜é˜ˆå€¼
// - ä½ç¼–è¯‘æ—¶é—´ + é«˜æ”¶ç›Š -> é™ä½é˜ˆå€¼
```

**è¯„ä»·**: âœ… è‡ªé€‚åº”é˜ˆå€¼è®¾è®¡åˆç†

#### 4.1.3 SIMD å‘é‡è¿ç®—

```rust
// vm-simd å¹³å°è‡ªé€‚åº”
pub fn vec_add(a: u64, b: u64, element_size: u8) -> u64 {
    platform::vec_add(a, b, element_size)
        .unwrap_or_else(|| fallback_vec_binop(...))
}

// æ”¯æŒ SSE2/AVX2/AVX-512/NEON è‡ªåŠ¨æ£€æµ‹
```

**è¯„ä»·**: âœ… å¹³å°ç‰¹å®šä¼˜åŒ–ï¼Œè‡ªåŠ¨å›é€€

### 4.2 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

#### ç“¶é¢ˆ 1: åŒæ­¥é”ç«äº‰

**ä½ç½®**: `vm-mem/src/lib.rs`

```rust
// å½“å‰å®ç° - æ¯æ¬¡è¯»å†™éƒ½éœ€è¦è·å–é”
fn read_phys(&self, pa: GuestPhysAddr, size: u8) -> Result<u64, Fault> {
    let mem = self.phys_mem.mem.read();  // æ¯æ¬¡è·å–è¯»é”
    // ...
}
```

**å½±å“**: é«˜é¢‘å†…å­˜è®¿é—®æ—¶é”ç«äº‰ä¸¥é‡

**å»ºè®®**:
```rust
// æ–¹æ¡ˆ 1: ä½¿ç”¨æ— é”æ•°æ®ç»“æ„
use crossbeam::atomic::AtomicCell;

// æ–¹æ¡ˆ 2: ç»†ç²’åº¦åˆ†åŒºé”
struct PhysicalMemory {
    partitions: Vec<RwLock<Vec<u8>>>,  // æŒ‰åœ°å€èŒƒå›´åˆ†åŒº
}

// æ–¹æ¡ˆ 3: ä½¿ç”¨ mmap ç›´æ¥æ˜ å°„
```

#### ç“¶é¢ˆ 2: è§£é‡Šå™¨è°ƒåº¦å¼€é”€

**ä½ç½®**: `vm-engine-interpreter/src/lib.rs`

```rust
// å½“å‰å®ç° - æ¯æ¡æŒ‡ä»¤ç‹¬ç«‹ match
for op in &block.ops {
    match op {
        IROp::Add { dst, src1, src2 } => { ... }
        IROp::Sub { ... } => { ... }
        // å¤§é‡åˆ†æ”¯
    }
}
```

**å»ºè®®**: å®ç°çº¿ç¨‹åŒ–è§£é‡Šå™¨ (Threaded Interpreter)

```rust
// ä½¿ç”¨ computed goto é£æ ¼çš„è°ƒåº¦
type OpHandler = fn(&mut Interpreter, &IROp, &mut dyn MMU);
static DISPATCH_TABLE: [OpHandler; 128] = [ ... ];

fn run_threaded(&mut self, mmu: &mut dyn MMU, block: &IRBlock) {
    for op in &block.ops {
        let handler = DISPATCH_TABLE[op.opcode() as usize];
        handler(self, op, mmu);
    }
}
```

#### ç“¶é¢ˆ 3: JIT ç¼–è¯‘å»¶è¿Ÿ

**ä½ç½®**: `vm-engine-jit/src/lib.rs`

**é—®é¢˜**: é¦–æ¬¡ç¼–è¯‘å»¶è¿Ÿå½±å“ç”¨æˆ·ä½“éªŒ

**å»ºè®®**:
```rust
// åå°é¢„ç¼–è¯‘çƒ­ç‚¹
pub fn background_compile(&self, pc: GuestAddr) {
    tokio::spawn(async move {
        // å¼‚æ­¥ç¼–è¯‘ï¼Œä¸é˜»å¡ä¸»æ‰§è¡Œ
        self.compile_block(pc);
    });
}

// ç¼–è¯‘ç¼“å­˜æŒä¹…åŒ–
pub fn save_cache(&self, path: &Path) -> Result<()>;
pub fn load_cache(&mut self, path: &Path) -> Result<()>;
```

### 4.3 å¼‚æ­¥ä¼˜åŒ–æœºä¼š

#### 4.3.1 å½“å‰å¼‚æ­¥ä½¿ç”¨

```rust
// vm-device/src/block.rs - å·²ä½¿ç”¨ tokio
pub async fn open<P: AsRef<Path>>(path: P, read_only: bool) -> std::io::Result<Self> {
    let file = File::open(path.as_ref()).await?;
    // ...
    tokio::spawn(async move {
        while let Some(req) = req_rx.recv().await {
            // å¼‚æ­¥å¤„ç† IO è¯·æ±‚
        }
    });
}
```

**è¯„ä»·**: âœ… å—è®¾å¤‡å·²æ­£ç¡®ä½¿ç”¨å¼‚æ­¥ IO

#### 4.3.2 å¯ä¼˜åŒ–ä¸ºå¼‚æ­¥çš„åœºæ™¯

| åœºæ™¯ | å½“å‰å®ç° | å»ºè®® |
|------|----------|------|
| å†…æ ¸åŠ è½½ | åŒæ­¥ `fs::read` | `tokio::fs::read` |
| å¿«ç…§ä¿å­˜ | åŒæ­¥å†™å…¥ | å¼‚æ­¥å†™å…¥ + å‹ç¼© |
| ç½‘ç»œè®¾å¤‡ | éƒ¨åˆ†å¼‚æ­¥ | å®Œå…¨å¼‚æ­¥åŒ– |
| GDB æœåŠ¡å™¨ | åŒæ­¥ TCP | `tokio::net::TcpListener` |

**ä¼˜åŒ–ç¤ºä¾‹**:

```rust
// å½“å‰ (vm-boot/src/lib.rs)
pub fn load_kernel(&self, memory: &mut dyn MMU) -> Result<GuestAddr, BootError> {
    let kernel_data = std::fs::read(kernel_path)?;  // åŒæ­¥é˜»å¡
    memory.write_bulk(load_addr, &kernel_data)?;
    Ok(load_addr)
}

// å»ºè®®
pub async fn load_kernel_async(&self, memory: &mut dyn MMU) -> Result<GuestAddr, BootError> {
    let kernel_data = tokio::fs::read(kernel_path).await?;
    // ä½¿ç”¨ spawn_blocking å¤„ç† CPU å¯†é›†æ“ä½œ
    tokio::task::spawn_blocking(move || {
        memory.write_bulk(load_addr, &kernel_data)
    }).await??;
    Ok(load_addr)
}
```

### 4.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®æ±‡æ€»

| ä¼˜åŒ–é¡¹ | é¢„æœŸæ”¶ç›Š | å¤æ‚åº¦ | ä¼˜å…ˆçº§ |
|--------|----------|--------|--------|
| å†…å­˜è®¿é—®æ— é”åŒ– | 30-50% | é«˜ | P0 |
| çº¿ç¨‹åŒ–è§£é‡Šå™¨ | 20-30% | ä¸­ | P1 |
| JIT åå°ç¼–è¯‘ | é¦–æ¬¡å»¶è¿Ÿé™ä½ | ä¸­ | P1 |
| å¼‚æ­¥å†…æ ¸åŠ è½½ | å¯åŠ¨æ—¶é—´é™ä½ | ä½ | P2 |
| ç¼–è¯‘ç¼“å­˜æŒä¹…åŒ– | å†·å¯åŠ¨åŠ é€Ÿ | ä¸­ | P2 |
| SIMD æŒ‡ä»¤æ‰¹å¤„ç† | å‘é‡è¿ç®—åŠ é€Ÿ | ä¸­ | P2 |

---

## 5. å¯ç»´æŠ¤æ€§æ£€æŸ¥

### 5.1 ä»£ç è´¨é‡

#### 5.1.1 æ–‡æ¡£å®Œæ•´æ€§

| æ¨¡å— | æ¨¡å—æ–‡æ¡£ | API æ–‡æ¡£ | ç¤ºä¾‹ä»£ç  | è¯„åˆ† |
|------|----------|----------|----------|------|
| vm-core | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… æœ‰ | â˜…â˜…â˜…â˜…â˜… |
| vm-ir | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… æœ‰ | â˜…â˜…â˜…â˜…â˜… |
| vm-mem | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âš ï¸ å°‘ | â˜…â˜…â˜…â˜…â˜† |
| vm-accel | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âœ… æœ‰ | â˜…â˜…â˜…â˜…â˜… |
| vm-device | âœ… å®Œæ•´ | âš ï¸ éƒ¨åˆ† | âš ï¸ å°‘ | â˜…â˜…â˜…â˜†â˜† |
| vm-engine-jit | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âš ï¸ å°‘ | â˜…â˜…â˜…â˜…â˜† |
| vm-frontend-* | âš ï¸ éƒ¨åˆ† | âš ï¸ éƒ¨åˆ† | âŒ æ—  | â˜…â˜…â˜…â˜†â˜† |

**æ–‡æ¡£ç¤ºä¾‹** (è‰¯å¥½):

```rust
/// ç¡¬ä»¶è™šæ‹ŸåŒ–åŠ é€Ÿå™¨ç»Ÿä¸€æ¥å£
///
/// æ­¤ trait å®šä¹‰äº†æ‰€æœ‰è™šæ‹ŸåŒ–åç«¯ï¼ˆKVMã€HVFã€WHPX ç­‰ï¼‰å¿…é¡»å®ç°çš„æ¥å£ï¼Œ
/// ä½¿å¾—ä¸Šå±‚ä»£ç å¯ä»¥ä»¥ç»Ÿä¸€çš„æ–¹å¼ä½¿ç”¨ä¸åŒçš„ç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚
///
/// # ç”Ÿå‘½å‘¨æœŸ
///
/// 1. **åˆ›å»º**: ä½¿ç”¨å¹³å°ç‰¹å®šçš„æ„é€ å‡½æ•°åˆ›å»ºåŠ é€Ÿå™¨å®ä¾‹
/// 2. **åˆå§‹åŒ–**: è°ƒç”¨ [`init()`](Accel::init) åˆå§‹åŒ–åŠ é€Ÿå™¨
/// ...
pub trait Accel { ... }
```

#### 5.1.2 ä»£ç é£æ ¼ä¸€è‡´æ€§

**æ£€æŸ¥é¡¹**:
- âœ… ä½¿ç”¨ rustfmt æ ¼å¼åŒ–
- âœ… å‘½åè§„èŒƒä¸€è‡´ (snake_case å‡½æ•°, CamelCase ç±»å‹)
- âœ… é”™è¯¯å¤„ç†ä½¿ç”¨ Result/Option
- âš ï¸ éƒ¨åˆ† unwrap() ä½¿ç”¨éœ€æ”¹è¿›

**é—®é¢˜ç¤ºä¾‹**:

```rust
// vm-service/src/lib.rs - å­˜åœ¨ unwrap
let mut vcpu = vcpu.lock().unwrap();  // åº”ä½¿ç”¨ ? æˆ– expect

// å»ºè®®
let mut vcpu = vcpu.lock()
    .map_err(|_| anyhow!("vCPU lock poisoned"))?;
```

### 5.2 æµ‹è¯•è¦†ç›–ç‡

#### 5.2.1 å•å…ƒæµ‹è¯•

```
vm-tests/src/lib.rs
â”œâ”€â”€ interpreter_runs_empty_block
â”œâ”€â”€ interpreter_add_executes
â”œâ”€â”€ interpreter_load_store_executes
â”œâ”€â”€ memorder_acquire_release_sequence_consistency
â”œâ”€â”€ interpreter_vecadd_basic
â”œâ”€â”€ interpreter_vecaddsat_signed_u8
â”œâ”€â”€ interpreter_vec128add_u8_basic
â”œâ”€â”€ interpreter_vec256_sat_matrix
â””â”€â”€ ... (æ›´å¤šå‘é‡æµ‹è¯•)

vm-mem/src/lib.rs
â”œâ”€â”€ test_bare_mode
â”œâ”€â”€ test_sv39_simple
â””â”€â”€ test_tlb_hit

vm-tests/tests/end_to_end.rs
â”œâ”€â”€ smoke_mmio_notify_block_device
â””â”€â”€ test_riscv64_simple_execution
```

**è¦†ç›–ç‡è¯„ä¼°**:

| æ¨¡å— | å•å…ƒæµ‹è¯• | é›†æˆæµ‹è¯• | è¯„ä¼° |
|------|----------|----------|------|
| vm-core | âš ï¸ å°‘ | - | éœ€å¢åŠ  |
| vm-ir | âš ï¸ å°‘ | - | éœ€å¢åŠ  |
| vm-mem | âœ… æœ‰ | - | è‰¯å¥½ |
| vm-engine-interpreter | âœ… å……åˆ† | âœ… æœ‰ | ä¼˜ç§€ |
| vm-engine-jit | âš ï¸ å°‘ | - | éœ€å¢åŠ  |
| vm-frontend-* | âš ï¸ å°‘ | - | éœ€å¢åŠ  |
| vm-device | âš ï¸ å°‘ | âœ… æœ‰ | ä¸­ç­‰ |

#### 5.2.2 æµ‹è¯•å»ºè®®

```rust
// å»ºè®®æ·»åŠ çš„æµ‹è¯•ç±»å‹

// 1. è¾¹ç•Œæµ‹è¯•
#[test]
fn test_memory_boundary_access() {
    let mut mmu = SoftMmu::new(0x1000, false);
    assert!(mmu.read(0x1000, 1).is_err());  // è¶Šç•Œ
}

// 2. å‹åŠ›æµ‹è¯•
#[test]
fn test_tlb_thrashing() {
    let mut mmu = SoftMmu::new(1024 * 1024, false);
    for i in 0..10000 {
        mmu.translate(i * 4096, AccessType::Read).unwrap();
    }
    // éªŒè¯ TLB æ›¿æ¢ç­–ç•¥
}

// 3. å¹¶å‘æµ‹è¯•
#[tokio::test]
async fn test_concurrent_memory_access() {
    // å¤šçº¿ç¨‹åŒæ—¶è®¿é—®å†…å­˜
}
```

### 5.3 æ¨¡å—åŒ–ç¨‹åº¦

**è€¦åˆåº¦åˆ†æ**:

```
vm-service ä¾èµ–:
â”œâ”€â”€ vm-core (æ ¸å¿ƒæŠ½è±¡) âœ… åˆç†
â”œâ”€â”€ vm-mem (MMU å®ç°) âœ… åˆç†
â”œâ”€â”€ vm-ir (IR å®šä¹‰) âœ… åˆç†
â”œâ”€â”€ vm-frontend-riscv64 (å…·ä½“è§£ç å™¨) âš ï¸ å¯æ”¹è¿›
â”œâ”€â”€ vm-engine-interpreter (å…·ä½“å¼•æ“) âš ï¸ å¯æ”¹è¿›
â””â”€â”€ vm-device (è®¾å¤‡å®ç°) âœ… åˆç†
```

**å»ºè®®**: é€šè¿‡å·¥å‚æ¨¡å¼è§£è€¦å…·ä½“å®ç°

```rust
// å½“å‰
let decoder = Box::new(RiscvDecoder);
let mut interpreter = Interpreter::new();

// å»ºè®® - æ³¨å…¥ä¾èµ–
pub struct VmService {
    decoder_factory: Box<dyn DecoderFactory>,
    engine_factory: Box<dyn EngineFactory>,
}

impl VmService {
    pub fn new(
        decoder_factory: impl DecoderFactory + 'static,
        engine_factory: impl EngineFactory + 'static,
    ) -> Self { ... }
}
```

### 5.4 é”™è¯¯å¤„ç†

**é”™è¯¯ç±»å‹è®¾è®¡**:

```rust
// vm-core - è‰¯å¥½çš„é”™è¯¯å±‚æ¬¡
pub enum VmError {
    Config(String),
    Memory(String),
    Device(String),
    Execution(Fault),
    AcceleratorUnavailable,
    Io(String),
}

// vm-accel - ä½¿ç”¨ thiserror
#[derive(Debug, thiserror::Error)]
pub enum AccelError {
    #[error("Accelerator not available: {0}")]
    NotAvailable(String),
    // ...
}
```

**è¯„ä»·**: âœ… é”™è¯¯ç±»å‹è®¾è®¡åˆç†ï¼Œä½¿ç”¨ thiserror ç®€åŒ–å®ç°

---

## 6. DDD åˆè§„æ€§éªŒè¯

### 6.1 è´«è¡€æ¨¡å‹è¯„ä¼°

#### 6.1.1 æ•°æ®å¯¹è±¡ (Entity/Value Object)

| ç±»å‹ | ç¤ºä¾‹ | æ˜¯å¦è´«è¡€ | è¯„ä¼° |
|------|------|----------|------|
| é…ç½®å¯¹è±¡ | `VmConfig`, `BootConfig` | âœ… æ˜¯ | çº¯æ•°æ®ç»“æ„ |
| åœ°å€ç±»å‹ | `GuestAddr`, `GuestPhysAddr` | âœ… æ˜¯ | ç±»å‹åˆ«å |
| çŠ¶æ€å®¹å™¨ | `VcpuStateContainer` | âœ… æ˜¯ | çº¯æ•°æ®ä¼ è¾“ |
| IR æ“ä½œ | `IROp`, `Terminator` | âœ… æ˜¯ | çº¯æ•°æ®æšä¸¾ |
| è®¾å¤‡ä¿¡æ¯ | `PciDeviceInfo`, `DeviceInfo` | âœ… æ˜¯ | çº¯æ•°æ®ç»“æ„ |

**ç¤ºä¾‹ - è´«è¡€æ¨¡å‹å®è·µ**:

```rust
// vm-core/src/lib.rs - çº¯æ•°æ®é…ç½®
#[derive(Debug, Clone, serde::Serialize, serde::Deserialize)]
pub struct VmConfig {
    pub guest_arch: GuestArch,
    pub memory_size: usize,
    pub vcpu_count: u32,
    pub exec_mode: ExecMode,
    // ... æ— è¡Œä¸ºæ–¹æ³•
}

// vm-ir/src/lib.rs - çº¯æ•°æ® IR
#[derive(Clone, Debug)]
pub enum IROp {
    Add { dst: RegId, src1: RegId, src2: RegId },
    Sub { dst: RegId, src1: RegId, src2: RegId },
    // ... æ— è¡Œä¸ºæ–¹æ³•
}
```

#### 6.1.2 æœåŠ¡å±‚ (Domain Service)

| æœåŠ¡ | èŒè´£ | è¯„ä¼° |
|------|------|------|
| `Interpreter` | IR æ‰§è¡ŒæœåŠ¡ | âœ… çº¯è¡Œä¸º |
| `Jit` | JIT ç¼–è¯‘æœåŠ¡ | âœ… çº¯è¡Œä¸º |
| `SoftMmu` | å†…å­˜ç®¡ç†æœåŠ¡ | âœ… çº¯è¡Œä¸º |
| `BootLoader` | å¯åŠ¨åŠ è½½æœåŠ¡ | âœ… çº¯è¡Œä¸º |
| `GdbServer` | è°ƒè¯•æœåŠ¡ | âœ… çº¯è¡Œä¸º |

**ç¤ºä¾‹ - æœåŠ¡ä¸æ•°æ®åˆ†ç¦»**:

```rust
// æ•°æ® (è´«è¡€)
pub struct IRBlock {
    pub start_pc: GuestAddr,
    pub ops: Vec<IROp>,
    pub term: Terminator,
}

// æœåŠ¡ (è¡Œä¸º)
impl ExecutionEngine<IRBlock> for Interpreter {
    fn run(&mut self, mmu: &mut dyn MMU, block: &IRBlock) -> ExecResult {
        // æ‰€æœ‰æ‰§è¡Œé€»è¾‘åœ¨æœåŠ¡ä¸­
        for op in &block.ops {
            self.execute_op(op, mmu);
        }
        // ...
    }
}
```

### 6.2 é¢†åŸŸè¾¹ç•Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨æœåŠ¡å±‚ (Application Service)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  VmService  â”‚  â”‚RuntimeCtrl  â”‚  â”‚ GdbSession  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    é¢†åŸŸæœåŠ¡å±‚ (Domain Service)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚Interpreterâ”‚ â”‚   Jit   â”‚ â”‚ SoftMmu â”‚ â”‚BootLoader â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    é¢†åŸŸæ¨¡å‹å±‚ (Domain Model)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚VmConfig â”‚ â”‚IRBlockâ”‚ â”‚GuestRegs â”‚ â”‚DeviceInfo  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    åŸºç¡€è®¾æ–½å±‚ (Infrastructure)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   KVM   â”‚ â”‚   HVF   â”‚ â”‚  WHPX   â”‚ â”‚  tokio  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 DDD åˆè§„æ€§æ€»ç»“

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æ•°æ®å¯¹è±¡æ— ä¸šåŠ¡é€»è¾‘ | âœ… ç¬¦åˆ | é…ç½®ã€çŠ¶æ€å‡ä¸ºçº¯æ•°æ® |
| æœåŠ¡å±‚æ‰¿è½½è¡Œä¸º | âœ… ç¬¦åˆ | Interpreter/Jit/MMU ç­‰ |
| é¢†åŸŸè¾¹ç•Œæ¸…æ™° | âœ… ç¬¦åˆ | æ¨¡å—èŒè´£æ˜ç¡® |
| ä¾èµ–æ–¹å‘æ­£ç¡® | âœ… ç¬¦åˆ | ä¸Šå±‚ä¾èµ–ä¸‹å±‚æŠ½è±¡ |
| Trait æŠ½è±¡æ¥å£ | âœ… ç¬¦åˆ | ExecutionEngine/MMU/Accel |

**è¯„ä»·**: âœ… é¡¹ç›®ä¸¥æ ¼éµå¾ª DDD è´«è¡€æ¨¡å‹åŸåˆ™ï¼Œæ•°æ®ä¸è¡Œä¸ºåˆ†ç¦»æ¸…æ™°

---

## 7. å…³é”®é—®é¢˜ä¸å»ºè®®æ±‡æ€»

### 7.1 é«˜ä¼˜å…ˆçº§é—®é¢˜

| # | é—®é¢˜ | ä½ç½® | å»ºè®® | å½±å“ |
|---|------|------|------|------|
| 1 | å†…å­˜è®¿é—®é”ç«äº‰ | vm-mem | å®ç°æ— é”è®¿é—®æˆ–åˆ†åŒºé” | æ€§èƒ½ |
| 2 | å‰ç«¯è§£ç å™¨æµ‹è¯•ä¸è¶³ | vm-frontend-* | å¢åŠ å•å…ƒæµ‹è¯• | ç¨³å®šæ€§ |
| 3 | unwrap æ»¥ç”¨ | vm-service | æ”¹ç”¨ ? æ“ä½œç¬¦ | å¥å£®æ€§ |
| 4 | RISC-V C æ‰©å±•ç¼ºå¤± | vm-frontend-riscv64 | å®ç°å‹ç¼©æŒ‡ä»¤ | åŠŸèƒ½ |

### 7.2 ä¸­ä¼˜å…ˆçº§é—®é¢˜

| # | é—®é¢˜ | ä½ç½® | å»ºè®® | å½±å“ |
|---|------|------|------|------|
| 5 | JIT é¦–æ¬¡ç¼–è¯‘å»¶è¿Ÿ | vm-engine-jit | åå°å¼‚æ­¥ç¼–è¯‘ | ä½“éªŒ |
| 6 | é…ç½®åˆ†æ•£ | å¤šæ¨¡å— | ç»Ÿä¸€é…ç½®ç®¡ç† | ç»´æŠ¤ |
| 7 | è§£é‡Šå™¨è°ƒåº¦å¼€é”€ | vm-engine-interpreter | çº¿ç¨‹åŒ–è§£é‡Šå™¨ | æ€§èƒ½ |
| 8 | åŒæ­¥æ–‡ä»¶åŠ è½½ | vm-boot | å¼‚æ­¥åŒ– | å¯åŠ¨æ—¶é—´ |

### 7.3 ä½ä¼˜å…ˆçº§é—®é¢˜

| # | é—®é¢˜ | ä½ç½® | å»ºè®® | å½±å“ |
|---|------|------|------|------|
| 9 | GPU è™šæ‹ŸåŒ–ä¸å®Œæ•´ | vm-device/gpu_* | å®Œå–„å®ç° | åŠŸèƒ½ |
| 10 | æ–‡æ¡£ç¤ºä¾‹ä¸è¶³ | vm-frontend-* | æ·»åŠ ä½¿ç”¨ç¤ºä¾‹ | æ˜“ç”¨æ€§ |
| 11 | ç¼–è¯‘ç¼“å­˜æ— æŒä¹…åŒ– | vm-engine-jit | æ·»åŠ æŒä¹…åŒ– | å†·å¯åŠ¨ |

### 7.4 æ”¹è¿›è·¯çº¿å›¾

```
Phase 1 (1-2 å‘¨): ç¨³å®šæ€§
â”œâ”€â”€ ä¿®å¤ unwrap æ»¥ç”¨
â”œâ”€â”€ å¢åŠ å‰ç«¯è§£ç å™¨æµ‹è¯•
â””â”€â”€ å®Œå–„é”™è¯¯å¤„ç†

Phase 2 (2-4 å‘¨): æ€§èƒ½
â”œâ”€â”€ å†…å­˜è®¿é—®ä¼˜åŒ–
â”œâ”€â”€ è§£é‡Šå™¨è°ƒåº¦ä¼˜åŒ–
â””â”€â”€ JIT åå°ç¼–è¯‘

Phase 3 (4-8 å‘¨): åŠŸèƒ½
â”œâ”€â”€ RISC-V C æ‰©å±•
â”œâ”€â”€ å®Œå–„ GPU è™šæ‹ŸåŒ–
â””â”€â”€ å¼‚æ­¥åŒ–æ”¹é€ 
```

---

## 8. é™„å½•

### 8.1 æ¨¡å—ä¾èµ–å…³ç³»å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ vm-cli   â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚vm-serviceâ”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚vm-engineâ”‚    â”‚ vm-mem  â”‚    â”‚vm-deviceâ”‚
    â”‚  -jit   â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚              â”‚
         â”‚         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”‚vm-accel â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚vm-engineâ”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â”‚vm-pass- â”‚
    â”‚-interp  â”‚         â”‚         â”‚through  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ vm-ir   â”‚    â”‚ vm-osal â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ vm-core â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 å…³é”® Trait æ¥å£

```rust
// æ‰§è¡Œå¼•æ“æ¥å£
pub trait ExecutionEngine<B>: Send {
    fn run(&mut self, mmu: &mut dyn MMU, block: &B) -> ExecResult;
    fn get_reg(&self, idx: usize) -> u64;
    fn set_reg(&mut self, idx: usize, val: u64);
    fn get_pc(&self) -> GuestAddr;
    fn set_pc(&mut self, pc: GuestAddr);
}

// å†…å­˜ç®¡ç†æ¥å£
pub trait MMU: Send + 'static {
    fn translate(&mut self, va: GuestAddr, access: AccessType) -> Result<GuestPhysAddr, Fault>;
    fn fetch_insn(&self, pc: GuestAddr) -> Result<u64, Fault>;
    fn read(&self, pa: GuestAddr, size: u8) -> Result<u64, Fault>;
    fn write(&mut self, pa: GuestAddr, val: u64, size: u8) -> Result<(), Fault>;
    fn map_mmio(&mut self, base: GuestAddr, size: u64, device: Box<dyn MmioDevice>);
    fn flush_tlb(&mut self);
}

// ç¡¬ä»¶åŠ é€Ÿæ¥å£
pub trait Accel {
    fn init(&mut self) -> Result<(), AccelError>;
    fn create_vcpu(&mut self, id: u32) -> Result<(), AccelError>;
    fn map_memory(&mut self, gpa: u64, hva: u64, size: u64, flags: u32) -> Result<(), AccelError>;
    fn run_vcpu(&mut self, vcpu_id: u32, mmu: &mut dyn MMU) -> Result<(), AccelError>;
}

// è§£ç å™¨æ¥å£
pub trait Decoder: Send {
    type Block;
    fn decode(&mut self, mmu: &dyn MMU, pc: GuestAddr) -> Result<Self::Block, Fault>;
}
```

### 8.3 ç‰ˆæœ¬ä¿¡æ¯

- Rust Edition: 2024
- ä¸»è¦ä¾èµ–:
  - `cranelift`: JIT ç¼–è¯‘åç«¯
  - `tokio`: å¼‚æ­¥è¿è¡Œæ—¶
  - `parking_lot`: é«˜æ€§èƒ½åŒæ­¥åŸè¯­
  - `thiserror`: é”™è¯¯å¤„ç†
  - `serde`: åºåˆ—åŒ–
  - `lru`: LRU ç¼“å­˜

---

## 9. é‡å¤å®ç°é—®é¢˜åˆ†æ

### 9.1 é—®é¢˜æ¦‚è¿°

åœ¨ä»£ç å®¡æŸ¥è¿‡ç¨‹ä¸­å‘ç°è‹¥å¹²é‡å¤å®ç°é—®é¢˜ï¼Œè¿™äº›é‡å¤ä»£ç å¢åŠ äº†ç»´æŠ¤æˆæœ¬ï¼Œå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´æ€§å’Œ Bugã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†åˆ†æï¼š

### 9.2 é‡å¤å®ç°æ¸…å•

#### 9.2.1 TLB å®ç° (ä¸¥é‡åº¦: é«˜ ğŸ”´)

| æ–‡ä»¶ä½ç½® | è¡Œå· | ç±»å‹ | æè¿° |
|----------|------|------|------|
| `vm-mem/src/lib.rs` | 77, 93 | `TlbEntry`, `Tlb` | ä¸»æ¨¡å—å†…çš„ TLB å®ç° |
| `vm-mem/src/tlb.rs` | 14, 73 | `TlbEntry`, `Tlb` | ç‹¬ç«‹ TLB æ¨¡å—å®ç° |
| `vm-mem/src/asm_opt.rs` | 195 | `TlbEntry` | æ±‡ç¼–ä¼˜åŒ–ç‰ˆæœ¬ |

**é—®é¢˜åˆ†æ**:
- ä¸‰å¤„ç‹¬ç«‹çš„ TLB å®ç°ï¼Œç»“æ„å’ŒåŠŸèƒ½é«˜åº¦ç›¸ä¼¼
- `lib.rs` å’Œ `tlb.rs` ä¸­çš„ `Tlb` ç»“æ„å‡ ä¹ç›¸åŒ
- `asm_opt.rs` ä¸­é¢å¤–å®šä¹‰äº†ç”¨äº SIMD ä¼˜åŒ–çš„ `TlbEntry`

**å»ºè®®**:
```rust
// æ¨è: ç»Ÿä¸€åˆ° vm-mem/src/tlb.rs
pub use tlb::{Tlb, TlbEntry};

// lib.rs ä¸­ç§»é™¤é‡å¤å®šä¹‰ï¼Œæ”¹ä¸º re-export
mod tlb;
pub use tlb::*;
```

#### 9.2.2 GpuManager å®ç° (ä¸¥é‡åº¦: ä¸­ ğŸŸ¡)

| æ–‡ä»¶ä½ç½® | è¡Œå· | æè¿° |
|----------|------|------|
| `vm-device/src/gpu_virt.rs` | 171 | è™šæ‹Ÿ GPU ç®¡ç†å™¨ |
| `vm-passthrough/src/gpu.rs` | 298 | GPU ç›´é€šç®¡ç†å™¨ |

**é—®é¢˜åˆ†æ**:
- ä¸¤ä¸ª `GpuManager` ç»“æ„å…·æœ‰ç›¸ä¼¼çš„ç®¡ç†èŒè´£
- `vm-device` ç‰ˆæœ¬å¤„ç†è™šæ‹ŸåŒ– GPU
- `vm-passthrough` ç‰ˆæœ¬å¤„ç†ç›´é€š GPU
- éƒ¨åˆ†ç®¡ç†é€»è¾‘ï¼ˆèµ„æºè¿½è¸ªã€è®¾å¤‡æšä¸¾ï¼‰å­˜åœ¨é‡å¤

**å»ºè®®**:
```rust
// æ–¹æ¡ˆ A: æŠ½å–å…¬å…± Trait
pub trait GpuManagement {
    fn list_devices(&self) -> Vec<GpuDevice>;
    fn allocate(&mut self, device_id: &str) -> Result<GpuHandle>;
    fn release(&mut self, handle: GpuHandle);
}

// æ–¹æ¡ˆ B: é‡å‘½åä»¥æ˜ç¡®èŒè´£
// vm-device: VirtualGpuManager
// vm-passthrough: PassthroughGpuManager
```

#### 9.2.3 SnapshotManager å®ç° (ä¸¥é‡åº¦: ä¸­ ğŸŸ¡)

| æ–‡ä»¶ä½ç½® | è¡Œå· | æè¿° |
|----------|------|------|
| `vm-core/src/snapshot.rs` | 14 | æ ¸å¿ƒå¿«ç…§ç®¡ç†å™¨ |
| `vm-boot/src/snapshot.rs` | 155 | å¯åŠ¨ç›¸å…³å¿«ç…§ç®¡ç†å™¨ |

**é—®é¢˜åˆ†æ**:
- `vm-core` ç‰ˆæœ¬æä¾›åŸºç¡€å¿«ç…§åŠŸèƒ½
- `vm-boot` ç‰ˆæœ¬æ‰©å±•äº†å¢é‡å¿«ç…§å’Œå¯åŠ¨æ—¶å¿«ç…§æ¢å¤
- å­˜åœ¨åŠŸèƒ½é‡å ï¼Œä½†èŒè´£ç•¥æœ‰ä¸åŒ

**å»ºè®®**:
```rust
// æ¨è: é‡‡ç”¨ç»„åˆæ¨¡å¼
// vm-core: ä¿æŒåŸºç¡€ SnapshotManager
// vm-boot: ä½¿ç”¨ BootSnapshotService åŒ…è£… vm-core çš„å®ç°
pub struct BootSnapshotService {
    core_manager: vm_core::SnapshotManager,
    incremental_engine: IncrementalSnapshotEngine,
}
```

#### 9.2.4 CpuFeatures å®ç° (ä¸¥é‡åº¦: ä½ ğŸŸ¢)

| æ–‡ä»¶ä½ç½® | è¡Œå· | æè¿° |
|----------|------|------|
| `vm-accel/src/lib.rs` | 135 | å†…è” CPU ç‰¹æ€§å®šä¹‰ |
| `vm-accel/src/cpuinfo.rs` | 30 | ç‹¬ç«‹ CPU ä¿¡æ¯æ¨¡å— |

**é—®é¢˜åˆ†æ**:
- `lib.rs` ä¸­æœ‰å†…è”çš„ `CpuFeatures` å®šä¹‰
- `cpuinfo.rs` æä¾›æ›´å®Œæ•´çš„ CPU æ£€æµ‹åŠŸèƒ½
- åŠŸèƒ½é‡å ä½† `cpuinfo.rs` æ›´å®Œå–„

**å»ºè®®**:
```rust
// æ¨è: åˆ é™¤ lib.rs ä¸­çš„å†…è”å®šä¹‰
// ç»Ÿä¸€ä½¿ç”¨ cpuinfo æ¨¡å—
pub use cpuinfo::CpuFeatures;
```

#### 9.2.5 KVM/HVF/WHPX å®ç°æ–‡ä»¶ (ä¸¥é‡åº¦: ä½ ğŸŸ¢)

åœ¨ `vm-accel/src/` ç›®å½•ä¸‹å­˜åœ¨é—ç•™çš„é‡æ„æ–‡ä»¶ï¼š

| å½“å‰æ–‡ä»¶ | é—ç•™æ–‡ä»¶ | çŠ¶æ€ |
|----------|----------|------|
| `kvm.rs` | `kvm.rs.old` | å®Œå…¨ç›¸åŒ |
| `hvf.rs` | `hvf.rs.old` | å®Œå…¨ç›¸åŒ |
| `whpx.rs` | `whpx.rs.old` | å®Œå…¨ç›¸åŒ |

åŒæ—¶å­˜åœ¨ `*_impl.rs` æ–‡ä»¶ (`kvm_impl.rs`, `hvf_impl.rs`, `whpx_impl.rs`)ï¼Œä¸å¯¹åº”çš„ä¸»æ–‡ä»¶å†…å®¹é«˜åº¦ç›¸ä¼¼ã€‚

**é—®é¢˜åˆ†æ**:
- `.old` æ–‡ä»¶æ˜¯é‡æ„é—ç•™ï¼Œåº”å½“åˆ é™¤
- `*.rs` å’Œ `*_impl.rs` æ–‡ä»¶å¯¹å­˜åœ¨å¤§é‡é‡å¤ä»£ç 
- å¯èƒ½æ˜¯é‡æ„è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€

**å»ºè®®**:
```bash
# 1. åˆ é™¤é—ç•™æ–‡ä»¶
rm vm-accel/src/*.old

# 2. æ•´åˆå®ç°æ–‡ä»¶
# å°† kvm.rs å’Œ kvm_impl.rs åˆå¹¶
# ä¿ç•™ä¸€ä¸ªè§„èŒƒçš„å®ç°
```

### 9.3 SIMD å¹³å°é‡å¤ (ä¸¥é‡åº¦: ä½ ğŸŸ¢)

åœ¨ `vm-simd` æ¨¡å—ä¸­ï¼Œå„å¹³å°å®ç°æ–‡ä»¶å­˜åœ¨ç›¸ä¼¼çš„å‘é‡æ“ä½œï¼š

| æ“ä½œ | x86_64 | ARM64 | WASM | é€šç”¨ |
|------|--------|-------|------|------|
| `vec_add` | âœ“ | âœ“ | âœ“ | âœ“ |
| `vec_sub` | âœ“ | âœ“ | âœ“ | âœ“ |
| `vec_mul` | âœ“ | âœ“ | âœ“ | âœ“ |
| `vec_div` | âœ“ | âœ“ | âœ“ | âœ“ |

**è¯„ä»·**: è¿™æ˜¯æœ‰æ„çš„å¹³å°ç‰¹åŒ–è®¾è®¡ï¼Œé€šè¿‡æ¡ä»¶ç¼–è¯‘é€‰æ‹©æœ€ä¼˜å®ç°ã€‚ä½†å¯è€ƒè™‘ï¼š
- ä½¿ç”¨å®å‡å°‘æ¨¡æ¿ä»£ç 
- æå–å…¬å…±æµ‹è¯•é€»è¾‘

### 9.4 é‡å¤ä»£ç ç»Ÿè®¡

| ç±»åˆ« | é‡å¤æ–‡ä»¶æ•° | ä¼°è®¡é‡å¤è¡Œæ•° | ä¼˜å…ˆçº§ |
|------|-----------|-------------|--------|
| TLB å®ç° | 3 | ~150 è¡Œ | é«˜ |
| GPU ç®¡ç†å™¨ | 2 | ~80 è¡Œ | ä¸­ |
| å¿«ç…§ç®¡ç†å™¨ | 2 | ~100 è¡Œ | ä¸­ |
| CPU ç‰¹æ€§ | 2 | ~30 è¡Œ | ä½ |
| åŠ é€Ÿå™¨é—ç•™æ–‡ä»¶ | 6 | ~800 è¡Œ | ä½ |
| **æ€»è®¡** | **15** | **~1160 è¡Œ** | - |

### 9.5 é‡æ„å»ºè®®ä¼˜å…ˆçº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‡æ„ä¼˜å…ˆçº§çŸ©é˜µ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é«˜å½±å“                                                      â”‚
â”‚    â”‚                                                         â”‚
â”‚    â”‚  [TLB ç»Ÿä¸€] â†â”€â”€ ä¼˜å…ˆå¤„ç†                                â”‚
â”‚    â”‚      â”‚                                                  â”‚
â”‚  ä¸­å½±å“   â”‚                                                  â”‚
â”‚    â”‚  [GPUç®¡ç†å™¨]  [å¿«ç…§ç®¡ç†å™¨]                              â”‚
â”‚    â”‚                                                         â”‚
â”‚  ä½å½±å“                                                      â”‚
â”‚    â”‚  [CPUç‰¹æ€§]  [.oldæ–‡ä»¶æ¸…ç†]                              â”‚
â”‚    â”‚                                                         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚        ä½å·¥ä½œé‡          ä¸­å·¥ä½œé‡          é«˜å·¥ä½œé‡           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.6 é‡æ„å®æ–½è®¡åˆ’

#### Phase 1: ç«‹å³æ‰§è¡Œ (1 å¤©)
1. åˆ é™¤æ‰€æœ‰ `.old` é—ç•™æ–‡ä»¶
2. ç»Ÿä¸€ `CpuFeatures` åˆ° `cpuinfo.rs`

#### Phase 2: çŸ­æœŸ (1 å‘¨)
1. åˆå¹¶ TLB å®ç°åˆ° `vm-mem/src/tlb.rs`
2. æ›´æ–°æ‰€æœ‰å¼•ç”¨ç‚¹

#### Phase 3: ä¸­æœŸ (2 å‘¨)
1. é‡æ„ `GpuManager`ï¼ŒæŠ½å–å…¬å…± Trait
2. æ•´åˆ `SnapshotManager`ï¼Œé‡‡ç”¨ç»„åˆæ¨¡å¼
3. åˆå¹¶ `kvm.rs`/`kvm_impl.rs` ç­‰æˆå¯¹æ–‡ä»¶

---

## 10. æ€»ç»“ä¸è¡ŒåŠ¨é¡¹

### 10.1 æ•´ä½“è¯„ä¼°æ›´æ–°

ç»¼åˆé‡å¤å®ç°åˆ†æåï¼Œé¡¹ç›®è¯„åˆ†è°ƒæ•´å¦‚ä¸‹ï¼š

| ç»´åº¦ | åŸè¯„åˆ† | è°ƒæ•´å | å˜åŒ–åŸå›  |
|------|--------|--------|----------|
| æ¶æ„è®¾è®¡ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | ç»´æŒ |
| åŠŸèƒ½å®Œæ•´æ€§ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | ç»´æŒ |
| æ€§èƒ½ä¼˜åŒ– | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜†â˜† | ç»´æŒ |
| å¯ç»´æŠ¤æ€§ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† | é‡å¤ä»£ç é™ä½å¯ç»´æŠ¤æ€§ |
| DDD åˆè§„æ€§ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | éƒ¨åˆ†é‡å¤è¿åå•ä¸€èŒè´£ |
| **ä»£ç è´¨é‡** | - | â˜…â˜…â˜…â˜†â˜† | æ–°å¢è¯„ä¼°ç»´åº¦ |

### 10.2 è¡ŒåŠ¨é¡¹æ¸…å•

| # | è¡ŒåŠ¨é¡¹ | è´Ÿè´£æ¨¡å— | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|---|--------|----------|--------|----------|
| 1 | åˆ é™¤ `.old` é—ç•™æ–‡ä»¶ | vm-accel | P0 | 0.5h |
| 2 | ç»Ÿä¸€ TLB å®ç° | vm-mem | P1 | 4h |
| 3 | åˆå¹¶ CpuFeatures | vm-accel | P1 | 1h |
| 4 | é‡æ„ GpuManager | vm-device, vm-passthrough | P2 | 8h |
| 5 | æ•´åˆ SnapshotManager | vm-core, vm-boot | P2 | 6h |
| 6 | åˆå¹¶ accel impl æ–‡ä»¶ | vm-accel | P3 | 4h |

---

**å®¡æŸ¥äºº**: AI Architecture Reviewer  
**å®¡æŸ¥æ—¥æœŸ**: 2025å¹´11æœˆ28æ—¥  
**è¡¥å……å®¡æŸ¥æ—¥æœŸ**: 2025å¹´11æœˆ28æ—¥ (é‡å¤å®ç°åˆ†æ)
