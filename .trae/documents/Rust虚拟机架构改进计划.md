# 改进目标
- 性能：完善 JIT 的内存语义与 MMU 集成，统一并发模型，减少锁争用与跨线程拷贝
- 可维护性：抽象边界更清晰、测试覆盖补齐、日志与错误统一
- 架构与DDD：弱化富领域对象，将运行编排下沉为服务层，强化接口契约

## 关键改进项
1. JIT 内存访问与 MMU 集成
- 在 `vm-engine-jit` 的 Load/Store 与原子指令路径中引入 `MMU.translate/read/write`，消除目前直接地址访问导致的越权/缺页风险
- 为 JIT 添加页错误、对齐与内存序标志处理，与 `vm-ir::MemFlags` 对齐（Acquire/Release/AcqRel）

2. 统一并发与异步模型
- 将 vCPU 执行线程收敛为 `async` 任务（Tokio），以统一与设备轮询的事件循环；使用 `select!` 处理中断与 I/O 请求
- 设备轮询频率由固定 10ms 改为自适应/基于通知的策略，减少空转

3. 解释器与JIT协作
- 在 `vm-service` 引入混合调度器：块级热点统计统一在服务层维护，解释器/JIT共享阈值与缓存池
- 解决 JIT `next_pc` 与运行上下文一致性问题，避免 `pc += 4` 的占位逻辑

4. 内存系统优化
- SoftMMU 的 TLB 容量与策略参数化，提供观测接口与基准；评估 `parking_lot::RwLock` 在热路径上的收益
- MMIO 通知语义标准化，统一队列事件触发与中断注入路径

5. I/O 与零拷贝
- 构建 I/O 调度器事件驱动接口，Linux 下接入真实 `io_uring`，跨平台保持环形缓冲后端；补齐 `attach_mmu` 后端使用案例

6. DDD 与分层
- 将 `VirtualMachine` 下的快照/模板/迁移操作迁移至 `vm-service` 或独立应用服务，保留领域对象为数据载体与接口集合
- 明确领域接口（执行引擎、解码器、MMU）为领域服务，应用编排负责业务流程

7. 工程与测试
- 为 `vm-engine-jit` 增加单元与集成测试，覆盖浮点、原子与条件分支的 JIT 路径
- 增加性能基准：解释器 vs JIT 在多架构/多负载下的对比；添加 CI 中的最小性能守卫
- 日志与错误统一到 `thiserror` + `tracing`，关键路径使用结构化日志

## 实施顺序
1. JIT 内存与 MMU语义修正（高优先）
2. 统一并发/异步模型与混合调度器
3. DDD 分层收敛与服务化迁移
4. I/O 后端完善与事件驱动
5. TLB/锁与内存系统调优
6. 测试与基准补齐、CI 扫描

## 交付物
- 修改后的 JIT 与服务层代码（含测试）
- 统一的错误与日志规范文档
- 基准报告与性能守卫阈值
- 架构图与分层说明，DDD 适配报告