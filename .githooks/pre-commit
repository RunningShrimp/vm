#!/bin/bash

# FVPè™šæ‹Ÿæœºç³»ç»Ÿé¢„æäº¤é’©å­
# åœ¨æ¯æ¬¡æäº¤å‰è¿è¡ŒåŸºæœ¬æ£€æŸ¥

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[âš ]${NC} $1"
}

print_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

print_header() {
    echo -e "${BLUE}=====================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}=====================================${NC}"
}

# è·å–è¦æäº¤çš„æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# å¦‚æœæ²¡æœ‰æš‚å­˜çš„æ–‡ä»¶ï¼Œé€€å‡º
if [ -z "$STAGED_FILES" ]; then
    print_info "æ²¡æœ‰æš‚å­˜çš„æ–‡ä»¶ï¼Œè·³è¿‡é¢„æäº¤æ£€æŸ¥"
    exit 0
fi

print_header "FVPè™šæ‹Ÿæœºç³»ç»Ÿé¢„æäº¤æ£€æŸ¥"
print_info "æ£€æŸ¥æš‚å­˜çš„æ–‡ä»¶:"

# æ˜¾ç¤ºè¦æ£€æŸ¥çš„æ–‡ä»¶
echo "$STAGED_FILES" | sed 's/^/  - /'

# æ£€æŸ¥æ˜¯å¦æœ‰Rustæ–‡ä»¶
RUST_FILES=$(echo "$STAGED_FILES" | grep -E '\.(rs|toml)$' || true)

if [ -z "$RUST_FILES" ]; then
    print_info "æ²¡æœ‰Rustæ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡Rustç›¸å…³æ£€æŸ¥"
    exit 0
fi

print_info "å‘ç°Rustæ–‡ä»¶å˜æ›´ï¼Œå¼€å§‹æ£€æŸ¥..."

# 1. ä»£ç æ ¼å¼æ£€æŸ¥
print_info "æ£€æŸ¥ä»£ç æ ¼å¼..."
if ! cargo fmt --all -- --check; then
    print_error "ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥ï¼"
    print_error "è¯·è¿è¡Œ 'cargo fmt' ä¿®å¤æ ¼å¼é—®é¢˜"
    exit 1
fi
print_success "ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

# 2. Clippyæ£€æŸ¥
print_info "è¿è¡ŒClippyæ£€æŸ¥..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    print_error "Clippyæ£€æŸ¥å¤±è´¥ï¼"
    print_error "è¯·ä¿®å¤Clippyè­¦å‘Šåå†æ¬¡æäº¤"
    exit 1
fi
print_success "Clippyæ£€æŸ¥é€šè¿‡"

# 3. ç¼–è¯‘æ£€æŸ¥
print_info "æ£€æŸ¥ç¼–è¯‘..."
if ! cargo check --all-features; then
    print_error "ç¼–è¯‘æ£€æŸ¥å¤±è´¥ï¼"
    exit 1
fi
print_success "ç¼–è¯‘æ£€æŸ¥é€šè¿‡"

# 4. å•å…ƒæµ‹è¯•ï¼ˆä»…è¿è¡Œå¿«é€Ÿæµ‹è¯•ï¼‰
print_info "è¿è¡Œå¿«é€Ÿå•å…ƒæµ‹è¯•..."
if ! cargo test --lib --quiet; then
    print_error "å•å…ƒæµ‹è¯•å¤±è´¥ï¼"
    exit 1
fi
print_success "å•å…ƒæµ‹è¯•é€šè¿‡"

# 5. æ–‡æ¡£æµ‹è¯•æ£€æŸ¥
print_info "æ£€æŸ¥æ–‡æ¡£..."
if ! cargo test --doc --quiet; then
    print_error "æ–‡æ¡£æµ‹è¯•å¤±è´¥ï¼"
    exit 1
fi
print_success "æ–‡æ¡£æµ‹è¯•é€šè¿‡"

# 6. æ£€æŸ¥å¤§æ–‡ä»¶
print_info "æ£€æŸ¥å¤§æ–‡ä»¶..."
MAX_FILE_SIZE=$((10 * 1024 * 1024)) # 10MB
LARGE_FILES=""

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        FILE_SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
        if [ "$FILE_SIZE" -gt "$MAX_FILE_SIZE" ]; then
            LARGE_FILES="$LARGE_FILES $file ($(($FILE_SIZE / 1024 / 1024))MB"
        fi
    fi
done

if [ -n "$LARGE_FILES" ]; then
    print_warning "å‘ç°å¤§æ–‡ä»¶ï¼ˆå¯èƒ½å½±å“æ€§èƒ½ï¼‰ï¼š"
    echo "$LARGE_FILES" | sed 's/^/  - /'
    print_warning "è¯·è€ƒè™‘ä½¿ç”¨Git LFSæˆ–å‡å°‘æ–‡ä»¶å¤§å°"
fi

# 7. æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
print_info "æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
SENSITIVE_PATTERNS=(
    "password"
    "secret"
    "token"
    "api[_-]key"
    "private[_-]key"
    "auth[_-]token"
)

SENSITIVE_FILES=""

for file in $STAGED_FILES; do
    if [ -f "$file" ] && [[ "$file" =~ \.(rs|toml|yaml|yml|json|env|md|sh)$ ]]; then
        for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if git diff --cached "$file" | grep -i "$pattern" > /dev/null; then
                SENSITIVE_FILES="$SENSITIVE_FILES $file"
                break
            fi
        done
    fi
done

if [ -n "$SENSITIVE_FILES" ]; then
    print_warning "å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ–‡ä»¶ï¼š"
    echo "$SENSITIVE_FILES" | sed 's/^/  - /'
    print_warning "è¯·ç¡®ä¿è¿™äº›æ–‡ä»¶ä¸åŒ…å«çœŸå®çš„æ•æ„Ÿä¿¡æ¯"
fi

# 8. æ£€æŸ¥TODO/FIXMEæ³¨é‡Š
print_info "æ£€æŸ¥TODO/FIXMEæ³¨é‡Š..."
TODO_FILES=""
FIXME_FILES=""

for file in $STAGED_FILES; do
    if [ -f "$file" ] && [[ "$file" =~ \.(rs|toml|yaml|yml|json|sh)$ ]]; then
        if git diff --cached "$file" | grep -i "TODO" > /dev/null; then
            TODO_FILES="$TODO_FILES $file"
        fi
        if git diff --cached "$file" | grep -i "FIXME" > /dev/null; then
            FIXME_FILES="$FIXME_FILES $file"
        fi
    fi
done

if [ -n "$TODO_FILES" ]; then
    print_warning "åŒ…å«TODOæ³¨é‡Šçš„æ–‡ä»¶ï¼š"
    echo "$TODO_FILES" | sed 's/^/  - /'
fi

if [ -n "$FIXME_FILES" ]; then
    print_warning "åŒ…å«FIXMEæ³¨é‡Šçš„æ–‡ä»¶ï¼š"
    echo "$FIXME_FILES" | sed 's/^/  - /'
    print_warning "è¯·ç¡®ä¿åœ¨æäº¤å‰å¤„ç†è¿™äº›FIXME"
fi

print_header "é¢„æäº¤æ£€æŸ¥å®Œæˆ"
print_success "æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥æäº¤ï¼ ğŸ‰"