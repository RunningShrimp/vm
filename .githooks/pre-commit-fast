#!/bin/bash

# Fast pre-commit hook for VM project
# This is a lightweight version (< 30 seconds) for frequent commits

set -e

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[âš ]${NC} $1"
}

print_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

print_header() {
    echo -e "${BLUE}=====================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}=====================================${NC}"
}

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Exit if no staged files
if [ -z "$STAGED_FILES" ]; then
    print_info "No staged files, skipping pre-commit checks"
    exit 0
fi

print_header "Fast Pre-commit Checks"
print_info "Checking staged files:"
echo "$STAGED_FILES" | sed 's/^/  - /'

# Check for Rust files
RUST_FILES=$(echo "$STAGED_FILES" | grep -E '\.(rs|toml)$' || true)

if [ -z "$RUST_FILES" ]; then
    print_info "No Rust files changed, skipping Rust checks"
    exit 0
fi

print_info "Rust files detected, running fast checks..."
echo ""

# 1. Quick format check (only on changed files)
print_info "Checking format of changed files..."
CHANGED_RS_FILES=$(echo "$STAGED_FILES" | grep -E '\.rs$' || true)
if [ -n "$CHANGED_RS_FILES" ]; then
    if ! echo "$CHANGED_RS_FILES" | xargs rustfmt --check; then
        print_error "Code format check failed!"
        print_error "Run 'cargo fmt' or use the fast format:"
        echo "$CHANGED_RS_FILES" | xargs rustfmt
        exit 1
    fi
fi
print_success "Format check passed"

# 2. Quick clippy check (only on changed packages)
print_info "Running Clippy on affected packages..."
# Get workspace members that changed
CHANGED_PACKAGES=$(echo "$STAGED_FILES" | grep -E '^[^/]*/' | sed 's|/.*||' | sort -u | grep -E '^vm-' || true)

if [ -n "$CHANGED_PACKAGES" ]; then
    for package in $CHANGED_PACKAGES; do
        if [ -d "$package" ]; then
            print_info "Checking $package..."
            if ! cargo clippy -p "$package" --all-targets -- -D warnings 2>/dev/null; then
                print_error "Clippy failed for $package"
                exit 1
            fi
        fi
    done
else
    # Fallback to workspace check if we can't determine packages
    if ! cargo clippy --workspace --all-targets -- -D warnings -A dead_code 2>&1 | head -20; then
        print_error "Clippy check failed!"
        exit 1
    fi
fi
print_success "Clippy check passed"

# 3. Quick compilation check
print_info "Checking compilation..."
if ! cargo check --workspace --quiet 2>&1 | tail -5; then
    print_warning "Compilation check has warnings (non-blocking)"
fi
print_success "Compilation check passed"

print_header "Fast checks completed"
print_success "Ready to commit! ðŸš€"
echo ""
print_warning "For full checks, run: .githooks/pre-commit"
