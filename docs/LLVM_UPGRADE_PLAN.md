# LLVMå‡çº§è®¡åˆ’

**åˆ›å»ºæ—¥æœŸ**: 2026-01-06
**çŠ¶æ€**: ğŸ“‹ è®¡åˆ’ä¸­
**ä¼˜å…ˆçº§**: P0 (é«˜ä¼˜å…ˆçº§)

---

## å½“å‰çŠ¶æ€

### å½“å‰ç‰ˆæœ¬
- `llvm-sys`: 180.0.0 (LLVM 18.0)
- `inkwell`: 0.5 with `llvm18-0` feature
- **è½å**: 31ä¸ªLLVMç‰ˆæœ¬ (18 â†’ å½“å‰19/20/21)

### é—®é¢˜åˆ†æ

1. **å®‰å…¨æ€§**: æ—§ç‰ˆæœ¬å¯èƒ½åŒ…å«æœªä¿®å¤çš„å®‰å…¨æ¼æ´
2. **æ€§èƒ½**: æ–°ç‰ˆæœ¬LLVMåŒ…å«æ€§èƒ½ä¼˜åŒ–
3. **åŠŸèƒ½**: ç¼ºå°‘æœ€æ–°çš„LLVMç‰¹æ€§å’Œä¼˜åŒ–
4. **å…¼å®¹æ€§**: ä¸å…¶ä»–ç°ä»£å·¥å…·é“¾ä¸å…¼å®¹

---

## å‡çº§ç›®æ ‡

### ç›®æ ‡ç‰ˆæœ¬

**æ–¹æ¡ˆA: æ¸è¿›å¼å‡çº§ (æ¨è)**
1. å…ˆå‡çº§åˆ° LLVM 19 (llvm-sys 190)
2. æµ‹è¯•å¹¶éªŒè¯
3. å†å‡çº§åˆ° LLVM 20 (llvm-sys 200)
4. æœ€åå‡çº§åˆ° LLVM 21 (llvm-sys 210)

**æ–¹æ¡ˆB: ç›´æ¥å‡çº§**
- ç›´æ¥å‡çº§åˆ° LLVM 21 (llvm-sys 210)
- é£é™©: ç ´åæ€§å˜æ›´å¯èƒ½è¾ƒå¤š

### inkwellå¯¹åº”å…³ç³»

| LLVMç‰ˆæœ¬ | llvm-sysç‰ˆæœ¬ | inkwellç‰ˆæœ¬ | feature |
|---------|-------------|------------|---------|
| 18.0 | 180 | 0.5 | `llvm18-0` |
| 19.1 | 191 | 0.6+ | `llvm19-0` |
| 20.0 | 200 | 0.7+ | `llvm20-0` (å¾…ç¡®è®¤) |
| 21.0 | 210 | æœªçŸ¥ | å¾…å‘å¸ƒ |

---

## å‡çº§æ­¥éª¤

### Phase 1: å‡†å¤‡ (1-2å¤©)

1. **ä»£ç å®¡è®¡**
   ```bash
   # æŸ¥æ‰¾æ‰€æœ‰LLVMç›¸å…³ä»£ç 
   grep -r "inkwell\|llvm_sys" --include="*.rs" vm-ir/
   ```

2. **ä¾èµ–æ£€æŸ¥**
   ```bash
   # æ£€æŸ¥å“ªäº›crateä¾èµ–vm-ir/llvm
   cargo tree -p vm-ir -i llvm
   ```

3. **æµ‹è¯•å¤‡ä»½**
   ```bash
   # è¿è¡Œç°æœ‰æµ‹è¯•ä½œä¸ºåŸºå‡†
   cargo test --package vm-ir --features llvm
   cargo test --workspace --features llvm
   ```

### Phase 2: å‡çº§åˆ°LLVM 19 (2-3å¤©)

1. **æ›´æ–°ä¾èµ–**
   ```toml
   # vm-ir/Cargo.toml
   [dependencies]
   inkwell = { version = "0.6", optional = true, features = ["llvm19-0"] }
   llvm-sys = { version = "190", optional = true }
   ```

2. **ç¼–è¯‘æ£€æŸ¥**
   ```bash
   cargo update
   cargo check --package vm-ir --features llvm
   ```

3. **ä¿®å¤ç ´åæ€§å˜æ›´**
   - æŸ¥çœ‹LLVM 19 release notes
   - æ›´æ–°APIè°ƒç”¨
   - å¤„ç†å¼ƒç”¨çš„åŠŸèƒ½

4. **æµ‹è¯•éªŒè¯**
   ```bash
   cargo test --package vm-ir --features llvm
   cargo build --workspace --features llvm
   ```

### Phase 3: å‡çº§åˆ°LLVM 20 (2-3å¤©)

é‡å¤Phase 2æ­¥éª¤ï¼Œä½¿ç”¨ï¼š
```toml
inkwell = { version = "0.7", optional = true, features = ["llvm20-0"] }
llvm-sys = { version = "200", optional = true }
```

### Phase 4: å‡çº§åˆ°LLVM 21 (å¦‚æœ‰inkwellæ”¯æŒ)

æ£€æŸ¥inkwellæ˜¯å¦æ”¯æŒLLVM 21ï¼Œå¦‚æœæ”¯æŒåˆ™é‡å¤Phase 2æ­¥éª¤ã€‚

---

## é£é™©è¯„ä¼°

### é«˜é£é™©åŒºåŸŸ

1. **APIå˜æ›´**
   - LLVM 19+å¯èƒ½æœ‰ç ´åæ€§APIå˜æ›´
   - inkwellå°è£…å¯èƒ½ä¸å®Œæ•´

2. **æ€§èƒ½å›å½’**
   - æ–°ç‰ˆæœ¬å¯èƒ½æ”¹å˜ä¼˜åŒ–è¡Œä¸º
   - éœ€è¦æ€§èƒ½åŸºå‡†æµ‹è¯•

3. **ç¼–è¯‘æ—¶é—´**
   - æ›´æ–°LLVMå¯èƒ½å¢åŠ ç¼–è¯‘æ—¶é—´
   - éœ€è¦è¯„ä¼°CI/CDå½±å“

### ç¼“è§£æªæ–½

1. **ç‰¹æ€§åˆ†æ”¯**
   ```bash
   git checkout -b upgrade/llvm-19
   ```

2. **æ¸è¿›å¼å‘å¸ƒ**
   - å…ˆåœ¨testç¯å¢ƒæµ‹è¯•
   - æ”¶é›†åé¦ˆåå†å‘å¸ƒ

3. **å›æ»šè®¡åˆ’**
   - ä¿ç•™æ—§ç‰ˆæœ¬ä»£ç åˆ†æ”¯
   - å‡†å¤‡å¿«é€Ÿå›æ»šè„šæœ¬

---

## æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
```bash
# vm-irå•å…ƒæµ‹è¯•
cargo test --package vm-ir --features llvm --lib

# é›†æˆæµ‹è¯•
cargo test --package vm-ir --features llvm -- '*integration*'
```

### åŠŸèƒ½æµ‹è¯•
```bash
# å®Œæ•´workspaceæµ‹è¯•
cargo test --workspace --features llvm

# ç‰¹å®šæ¨¡å—æµ‹è¯•
cargo test --package vm-engine-jit --features llvm
```

### æ€§èƒ½æµ‹è¯•
```bash
# åŸºå‡†æµ‹è¯•
cargo bench --features llvm

# ä¸æ—§ç‰ˆæœ¬å¯¹æ¯”
# è®°å½•æ€§èƒ½æŒ‡æ ‡
```

---

## æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº |
|------|------|---------|--------|
| 1 | å‡†å¤‡å’Œå®¡è®¡ | 1-2å¤© | - |
| 2 | å‡çº§åˆ°LLVM 19 | 2-3å¤© | - |
| 3 | å‡çº§åˆ°LLVM 20 | 2-3å¤© | - |
| 4 | å‡çº§åˆ°LLVM 21 | 2-3å¤© | - |
| 5 | æµ‹è¯•å’ŒéªŒè¯ | 3-5å¤© | - |
| 6 | æ–‡æ¡£æ›´æ–° | 1å¤© | - |
| **æ€»è®¡** | **å®Œæ•´å‡çº§** | **11-17å¤©** | - |

---

## æˆåŠŸæ ‡å‡†

### ç¼–è¯‘æˆåŠŸ
- âœ… `cargo build --workspace --features llvm` æˆåŠŸ
- âœ… 0ä¸ªç¼–è¯‘é”™è¯¯
- âœ… 0ä¸ªæ–°çš„è­¦å‘Š (é™¤äº†æ—§LLVMç‰¹æœ‰çš„)

### æµ‹è¯•é€šè¿‡
- âœ… æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
- âœ… æµ‹è¯•è¦†ç›–ç‡ä¸é™ä½
- âœ… æ— æ–°å¼•å…¥çš„bug

### æ€§èƒ½ä¿æŒ
- âœ… æ€§èƒ½ä¸ä½äºæ—§ç‰ˆæœ¬çš„95%
- âœ… å…³é”®æ€§èƒ½æŒ‡æ ‡ä¸å›é€€

### æ–‡æ¡£å®Œæ•´
- âœ… æ›´æ–°æ‰€æœ‰LLVMç›¸å…³æ–‡æ¡£
- âœ… è®°å½•APIå˜æ›´
- âœ… æä¾›è¿ç§»æŒ‡å—

---

## å›æ»šè®¡åˆ’

å¦‚æœå‡çº§å¤±è´¥ï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **å›é€€ä»£ç **
   ```bash
   git revert <upgrade-commits>
   ```

2. **å›é€€ä¾èµ–**
   ```toml
   # æ¢å¤æ—§ç‰ˆæœ¬
   inkwell = { version = "0.5", features = ["llvm18-0"] }
   llvm-sys = { version = "180" }
   ```

3. **æ¸…ç†æ„å»º**
   ```bash
   cargo clean
   cargo build
   ```

4. **é€šçŸ¥å›¢é˜Ÿ**
   - è®°å½•å¤±è´¥åŸå› 
   - åˆ¶å®šæ–°è®¡åˆ’
   - è°ƒæ•´æ—¶é—´è¡¨

---

## å‚è€ƒèµ„æ–™

- [LLVM Release Notes](https://releases.llvm.org/)
- [inkwell Repository](https://github.com/TheDan64/inkwell)
- [llvm-sys Repository](https://github.com/tov/llvm-sys.rs)
- [LLVM 19 Migration Guide](https://llvm.org/docs/ReleaseNotes.html)

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… å®¡æŸ¥æ­¤è®¡åˆ’
2. â³ è·å¾—å›¢é˜Ÿæ‰¹å‡†
3. â³ åˆ›å»ºç‰¹æ€§åˆ†æ”¯
4. â³ å¼€å§‹Phase 1: å‡†å¤‡å’Œå®¡è®¡

---

**åˆ›å»ºè€…**: VMé¡¹ç›®ä¼˜åŒ–å›¢é˜Ÿ
**å®¡æŸ¥è€…**: å¾…å®š
**æœ€åæ›´æ–°**: 2026-01-06
