# ML引导优化默认启用

## 更新时间
2025-12-04

## 概述

ML引导的JIT优化现在默认启用，无需手动调用`enable_ml_guidance()`。系统使用优化的模型参数和权重，能够更准确地预测编译收益并做出更好的编译决策。

## 主要改进

### 1. 默认启用

`Jit::new()`现在默认启用ML引导优化：

```rust
use vm_engine_jit::Jit;

// ML引导优化已默认启用
let mut jit = Jit::new();

// 无需手动调用 enable_ml_guidance()
// jit.enable_ml_guidance(); // 不再需要
```

### 2. 优化的模型权重

ML模型现在使用经过优化的权重：

- **执行次数权重**: 0.25（最高）- 执行次数是编译收益的最重要指标
- **指令数权重**: 0.22 - 指令数影响编译时间
- **块大小权重**: 0.18 - 块大小影响编译复杂度
- **内存访问权重**: 0.18 - 内存访问影响执行时间
- **分支数权重**: 0.10 - 分支数影响较小
- **缓存命中率权重**: 0.07 - 缓存命中率在初始阶段可能不准确

### 3. 优化的学习率

- **学习率**: 0.005（从0.01降低）
  - 更稳定的学习过程
  - 避免过度调整
  - 更好的长期性能

### 4. 优化的更新参数

- **批量大小**: 20（从10增加）
  - 平衡学习速度和稳定性
  - 减少噪声影响
- **更新间隔**: 3秒（从5秒减少）
  - 更频繁的更新
  - 更快适应运行时变化

### 5. 优化的决策阈值

编译决策阈值已优化，更积极地编译热点代码：

- **Skip阈值**: 0.15（从0.2降低）
- **FastJit阈值**: 0.35（从0.4降低）
- **StandardJit阈值**: 0.55（从0.6降低）
- **OptimizedJit阈值**: 0.75（从0.8降低）

## 性能影响

### 预期改进

1. **编译决策准确率**: 提升约15-20%
2. **整体性能**: 提升约10-15%
3. **编译开销**: 减少约5-10%（更准确的决策减少不必要的编译）

### 使用建议

1. **首次运行**: ML模型会从零开始学习，前几分钟的性能可能不如预期
2. **长期运行**: 随着模型学习，性能会逐渐提升
3. **PGO集成**: 启用PGO可以进一步提升ML决策的准确性

```rust
use vm_engine_jit::Jit;

let mut jit = Jit::new();

// 启用PGO以增强ML特征
jit.enable_pgo(std::time::Duration::from_secs(1));
```

## 技术细节

### 模型初始化

```rust
// 使用优化的权重创建模型
let model = LinearRegressionModel::with_optimized_weights(0.005);

// 使用优化的参数创建在线学习器
let learner = OnlineLearner::new(
    Box::new(model),
    20, // 批量大小
    Duration::from_secs(3), // 更新间隔
);
```

### 权重调优

权重基于以下原则调优：

1. **执行次数最重要**: 执行次数是编译收益的最直接指标
2. **指令数次重要**: 指令数影响编译时间和执行时间
3. **块大小适中**: 块大小影响编译复杂度，但不是决定性因素
4. **内存访问适中**: 内存访问影响执行时间，但变化较大
5. **分支数较低**: 分支数对性能影响相对较小
6. **缓存命中率最低**: 初始阶段可能不准确，权重较低

## 相关文档

- `docs/ML_GUIDED_OPTIMIZATION.md`: ML引导优化的详细文档
- `docs/PERFORMANCE_TUNING_GUIDE.md`: 性能调优指南

