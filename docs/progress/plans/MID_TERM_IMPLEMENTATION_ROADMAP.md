# 中期计划实施路线图

## 创建时间
2024年12月24日

## 概述

本文档为《Rust虚拟机软件改进实施计划》的中期计划提供了详细的实施路线图，包括时间线、里程碑、依赖关系和关键决策点。

---

## 一、中期计划概览

| 任务 | 预计工作量 | 关键路径 | 风险等级 |
|------|------------|---------|---------|
| 任务5：完善RISC-V支持 | 3-4个月 | 中 | 中 |
| 任务6：简化模块依赖 | 3-4个月 | 高 | 高 |
| 任务7：实现ARM SMMU | 4-6个月 | 高 | 高 |

---

## 二、任务5：完善RISC-V支持

### 2.1 当前状态
- **完成度**：35%（从30%提升到35%）
- **已完成**：
  - ✅ 16个基础RISC-V指令特征
  - ✅ 指令特征数据结构
  - ✅ 基础RISC-V支持框架
- **进行中**：
  - 🔄 扩展指令集支持分析
  - 🔄 RISC-V扩展模块设计

### 2.2 实施路线

#### 阶段1：RISC-V扩展模块设计（第1-2周）

**目标**：设计RISC-V扩展支持模块

**工作内容**：
1. **分析RISC-V扩展规范**
   - [ ] 研究RISC-V官方规范文档
   - [ ] 分析各扩展的指令集和功能
   - [ ] 识别必须实现的指令

2. **设计扩展模块架构**
   ```
   vm-ir/riscv_extensions/
   ├── Cargo.toml
   └── src/
       ├── lib.rs (公共接口)
       ├── m_extension.rs (M扩展)
       ├── a_extension.rs (A扩展)
       ├── f_extension.rs (F扩展)
       ├── d_extension.rs (D扩展)
       └── c_extension.rs (C扩展)
   ```

3. **定义扩展接口**
   ```rust
   pub trait RiscVExtension: Send + Sync {
       fn name(&self) -> &str;
       fn supported_instructions(&self) -> Vec<&str>;
       fn initialize(&mut self, features: &mut HashMap<String, InstructionFeatures>) -> Result<(), VmError>;
   }
   ```

4. **实现M扩展（乘法）**
   - [ ] MULH (Multiply High)
   - [ ] MULHSU (Multiply High Signed Unsigned)
   - [ ] MULHU (Multiply High Unsigned)
   - [ ] MULW (Multiply Word)
   - [ ] DIVU (Divide Unsigned)
   - [ ] REMU (Remainder Unsigned)
   - [ ] REMW (Remainder Word)
   - [ ] REMUW (Remainder Unsigned Word)
   - [ ] REMUW (Remainder Unsigned Word)

5. **实现A扩展（原子）**
   - [ ] LR.W (Load-Reserved Word)
   - [ ] SC.W (Store-Conditional Word)
   - [ ] AMOSWAP.W (Atomic Swap Word)
   - [ ] AMOADD.W (Atomic Add Word)

6. **实现F扩展（单精度浮点）**
   - [ ] FLW (Floating Load Word)
   - [ ] FSW (Floating Store Word)
   - [ ] FADD.S (Floating Add Single)
   - [ ] FSUB.S (Floating Subtract Single)
   - [ ] FMUL.S (Floating Multiply Single)
   - [ ] FDIV.S (Floating Divide Single)
   - [ ] FSQRT.S (Floating Square Root Single)

7. **实现D扩展（双精度浮点）**
   - [ ] FLD (Floating Load Double)
   - [ ] FSD (Floating Store Double)
   - [ ] FADD.D (Floating Add Double)
   - [ ] FSUB.D (Floating Subtract Double)
   - [ ] FMUL.D (Floating Multiply Double)
   - [ ] FDIV.D (Floating Divide Double)
   - [ ] FSQRT.D (Floating Square Root Double)
   - [ ] FMAX.D (Floating Maximum Double)
   - [ ] FMIN.D (Floating Minimum Double)

8. **实现C扩展（压缩）**
   - [ ] C.ADD (Compress Add)
   - [ ] C.SUB (Compress Subtract)
   - [ ] C.AND (Compress AND)
   - [ ] C.OR (Compress OR)
   - [ ] C.XOR (Compress XOR)
   - [ ] C.SLL (Compress Shift Left Logical)
   - [ ] C.SRL (Compress Shift Right Logical)

**产出**：
- RISC-V扩展模块设计文档
- 扩展接口定义
- 指令清单和优先级

#### 阶段2：实现RISC-V扩展（第3-8周）

**目标**：按照优先级实现各扩展

**实施顺序**：
1. **M扩展（第3周）** - 优先级最高
2. **A扩展（第4周）** - 优先级高
3. **F扩展（第5周）** - 优先级高
4. **D扩展（第6周）** - 优先级中
5. **C扩展（第7-8周）** - 优先级低

**工作内容**：
- [ ] 在vm-ir中创建riscv_extensions模块
- [ ] 实现每个扩展的指令特征
- [ ] 添加指令到特征映射表
- [ ] 实现扩展接口
- [ ] 测试验证

**产出**：
- 完整的RISC-V扩展支持
- 80+个扩展指令特征
- 扩展模块代码

#### 阶段3：RISC-V特权指令（第9-10周）

**目标**：实现RISC-V特权级指令

**特权指令清单**：
1. **ECALL/ERET** - 环境调用/返回
2. **EBREAK** - 环境断点
3. **CSRRW/CSRRC** - 控制/状态寄存器读写
4. **CSRRWI** - 控制寄存器写立即数
5. **SFENCE.VMA** - 虚拟内存栅栏

**工作内容**：
- [ ] 设计特权指令接口
- [ ] 实现CSR（控制和状态寄存器）访问
- [ ] 实现异常处理
- [ ] 实现环境调用机制
- [ ] 测试验证

**产出**：
- 完整的RISC-V特权指令支持
- CSR寄存器管理系统
- 异常处理机制

#### 阶段4：RISC-V特定优化（第11-12周）

**目标**：实现RISC-V特定优化

**优化领域**：
1. **分支预测**
2. **循环优化**
3. **访存优化**
4. **指令调度**
5. **SIMD扩展利用**

**工作内容**：
- [ ] 分析RISC-V优化机会
- [ ] 实现分支预测器
- [ ] 实现循环优化器
- [ ] 优化访存指令
- [ ] 指令调度优化
- [ ] SIMD向量化利用
- [ ] 测试验证

**产出**：
- RISC-V性能优化模块
- 性能基准测试结果
- 优化文档

### 2.3 关键里程碑

| 里程碑 | 时间 | 验收标准 | 依赖 |
|--------|------|---------|------|
| M1：扩展模块设计完成 | 第2周 | 设计文档完成 | - |
| M2：M/A扩展完成 | 第5周 | 测试通过 | M1 |
| M3：F/D/C扩展完成 | 第9周 | 测试通过 | M2 |
| M4：特权指令完成 | 第11周 | 测试通过 | M3 |
| M5：优化完成 | 第13周 | 性能提升>10% | M4 |
| M6：RISC-V支持完整 | 第14周 | 功能完整度80% | M5 |

### 2.4 成功标准

- [ ] 支持的指令数：100+个（当前16个 + 84个扩展）
- [ ] 扩展支持：M, A, F, D, C
- [ ] 特权指令：CSR访问、异常处理、环境调用
- [ ] 优化功能：分支预测、循环优化、访存优化
- [ ] RISC-V功能完整度：80%
- [ ] 测试覆盖率：>85% for RISC-V

---

## 三、任务6：简化模块依赖

### 3.1 当前状态
- **完成度**：10%（从5%提升到10%）
- **已完成**：
  - ✅ 分析53个crate的职责和依赖
  - ✅ 识别了4个主要依赖关系问题
  - ✅ 制定了12周的详细简化计划
  - ✅ 创建了详细的实施指南

### 3.2 实施路线

#### 阶段1：预合并准备（第1周）

**目标**：为模块合并做好准备工作

**工作内容**：
1. **详细依赖分析**
   - [ ] 绘制完整的依赖关系图
   - [ ] 识别循环依赖（如果存在）
   - [ ] 分析每个模块的输入/输出

2. **API兼容性评估**
   - [ ] 分析每个模块的公共API
   - [ ] 识别需要保持的接口
   - [ ] 设计迁移策略

3. **风险评估**
   - [ ] 评估每个合并的风险
   - [ ] 制定缓解措施
   - [ ] 准备回滚计划

4. **实施指南细化**
   - [ ] 为每个合并创建详细步骤
   - [ ] 制定测试策略
   - [ ] 准备文档更新计划

**产出**：
- 完整的依赖关系图
- API兼容性评估报告
- 风险评估和缓解计划
- 细化的实施指南

#### 阶段2：编码/解码模块合并（第2-3周）

**目标**：将vm-frontend-*整合到vm-encoding

**工作内容**：
1. **创建vm-encoding模块**
   - [ ] 设置Cargo.toml
   - [ ] 创建基础结构（lib.rs）
   - [ ] 定义统一接口

2. **迁移ARM64解码器**（第2周）
   - [ ] 将vm-frontend-arm64的解码逻辑移到vm-encoding/arm64.rs
   - [ ] 调整为统一的接口
   - [ ] 更新所有引用
   - [ ] 测试验证

3. **迁移x86-64解码器**（第2周，与ARM64并行）
   - [ ] 将vm-frontend-x86_64的解码逻辑移到vm-encoding/x86_64.rs
   - [ ] 调整为统一的接口
   - [ ] 更新所有引用
   - [ ] 测试验证

4. **迁移RISC-V解码器**（第3周）
   - [ ] 将vm-frontend-riscv64的解码逻辑移到vm-encoding/riscv64.rs
   - [ ] 调整为统一的接口
   - [ ] 更新所有引用
   - [ ] 测试验证

5. **删除旧模块**
   - [ ] 删除vm-frontend-arm64
   - [ ] 删除vm-frontend-x86_64
   - [ ] 删除vm-frontend-riscv64
   - [ ] 更新workspace members

**产出**：
- 新的vm-encoding模块
- 4个架构解码器整合
- 减少3个模块
- 减少约1,500行重复代码

#### 阶段3：平台相关模块合并（第4-5周）

**目标**：将vm-osal, vm-passthrough, vm-boot合并为vm-platform

**工作内容**：
1. **创建vm-platform模块**（第4周）
   - [ ] 设置Cargo.toml
   - [ ] 创建基础结构（lib.rs）
   - [ ] 定义统一接口

2. **迁移OS抽象层**（第4周）
   - [ ] 将vm-osal的核心逻辑移到vm-platform/src/osal.rs
   - [ ] 调整为统一的接口
   - [ ] 更新所有引用
   - [ ] 测试验证

3. **迁移直通功能**（第5周）
   - [ ] 将vm-passthrough的核心逻辑移到vm-platform/src/passthrough.rs
   - [ ] 调整为统一的接口
   - [ ] 更新所有引用
   - [ ] 测试验证

4. **迁移启动加载器**（第5周）
   - [ ] 将vm-boot的核心逻辑移到vm-platform/src/boot.rs
   - [ ] 调整为统一的接口
   - [ ] 更新所有引用
   - [ ] 测试验证

5. **删除旧模块**
   - [ ] 删除vm-osal
   - [ ] 删除vm-passthrough
   - [ ] 删除vm-boot
   - [ ] 更新workspace members

**产出**：
- 新的vm-platform模块
- 3个平台组件整合
- 减少3个模块
- 减少约800行重复代码

#### 阶段4：辅助功能模块合并（第6-8周）

**目标**：合并编码相关、优化相关、资源管理模块

**工作内容**：
1. **合并编码相关模块**（第6周）
   - [ ] 创建vm-instruction-support模块
   - [ ] 整合vm-encoding
   - [ ] 整合vm-register
   - [ ] 整合vm-memory-access
   - [ ] 删除旧模块
   - [ ] 更新引用

2. **合并优化相关模块**（第7周）
   - [ ] 创建vm-optimization-framework模块
   - [ ] 整合vm-optimization
   - [ ] 整合vm-instruction-patterns
   - [ ] 整合vm-resource
   - [ ] 删除旧模块
   - [ ] 更新引用

3. **合并资源管理模块**（第8周）
   - [ ] 整合剩余资源管理模块
   - [ ] 删除旧模块
   - [ ] 更新引用

**产出**：
- 新的vm-instruction-support模块（3个合并）
- 新的vm-optimization-framework模块（4个合并）
- 减少7个模块
- 减少约1,500行重复代码

#### 阶段5：监控和服务模块合并（第9-10周）

**目标**：将vm-service, vm-monitor, vm-adaptive合并为vm-ops

**工作内容**：
1. **创建vm-ops模块**（第9周）
   - [ ] 设置Cargo.toml
   - [ ] 创建基础结构（lib.rs）
   - [ ] 定义统一接口

2. **迁移服务管理**（第9周）
   - [ ] 将vm-service的核心逻辑移到vm-ops/src/service.rs
   - [ ] 调整为统一的接口
   - [ ] 更新所有引用
   - [ ] 测试验证

3. **迁移监控功能**（第10周）
   - [ ] 将vm-monitor的核心逻辑移到vm-ops/src/monitor.rs
   - [ ] 调整为统一的接口
   - [ ] 更新所有引用
   - [ ] 测试验证

4. **迁移自适应优化**（第10周）
   - [ ] 将vm-adaptive的核心逻辑移到vm-ops/src/adaptive.rs
   - [ ] 调整为统一的接口
   - [ ] 更新所有引用
   - [ ] 测试验证

5. **删除旧模块**
   - [ ] 删除vm-service
   - [ ] 删除vm-monitor
   - [ ] 删除vm-adaptive
   - [ ] 更新workspace members

**产出**：
- 新的vm-ops模块（3个合并）
- 减少3个模块
- 减少约900行重复代码

#### 阶段6：测试和基准测试模块整合（第11-12周）

**目标**：将14个测试和基准测试模块整合为vm-benchmarks和vm-tests

**工作内容**：
1. **整合性能测试模块**（第11周）
   - [ ] 创建vm-benchmarks模块
   - [ ] 整合perf-bench, vm-perf-regression-detector
   - [ ] 整合tiered-compiler, parallel-jit
   - [ ] 删除旧模块
   - [ ] 更新引用

2. **整合功能测试模块**（第11-12周）
   - [ ] 创建vm-tests模块
   - [ ] 整合gc-optimizer, memory-optimizer
   - [ ] 整合vm-cross-arch-integration-tests, vm-stress-test-runner
   - [ ] 删除旧模块
   - [ ] 更新引用

3. **整合研究性模块**（第12周，可选）
   - [ ] 创建vm-research模块
   - [ ] 整合ml-guided-compiler, pgo-optimizer
   - [ ] 删除旧模块
   - [ ] 更新引用

**产出**：
- 新的vm-benchmarks模块（6个合并）
- 新的vm-tests模块（6个合并）
- 减少12个模块
- 减少约5,000行重复代码

#### 阶段7：最终验证和文档（第13周）

**目标**：完成所有合并并进行最终验证

**工作内容**：
1. **最终测试验证**
   - [ ] 运行完整测试套件
   - [ ] 验证所有功能正常工作
   - [ ] 性能基准测试
   - [ ] 回归测试

2. **编译时间测量**
   - [ ] 测量完全编译时间（debug）
   - [ ] 测量增量编译时间（debug）
   - [ ] 对比优化前后
   - [ ] 测量完全编译时间（release）
   - [ ] 测量增量编译时间（release）

3. **依赖关系验证**
   - [ ] 验证无循环依赖
   - [ ] 验证依赖深度目标达成
   - [ ] 验证分支因子目标达成

4. **文档更新**
   - [ ] 更新所有架构文档
   - [ ] 更新API文档
   - [ ] 创建迁移指南
   - [ ] 创建最佳实践文档

**产出**：
- 测试验证报告
- 编译时间对比报告
- 依赖关系验证报告
- 更新的文档体系

### 3.3 关键里程碑

| 里程碑 | 时间 | 验收标准 | 依赖 |
|--------|------|---------|------|
| M1：依赖分析完成 | 第1周 | 分析文档完成 | - |
| M2：编码/解码合并完成 | 第4周 | 测试通过 | M1 |
| M3：平台模块合并完成 | 第6周 | 测试通过 | M2 |
| M4：辅助模块合并完成 | 第9周 | 测试通过 | M3 |
| M5：监控服务合并完成 | 第11周 | 测试通过 | M4 |
| M6：测试模块整合完成 | 第13周 | 测试通过 | M5 |
| M7：最终验证完成 | 第14周 | 所有验证通过 | M6 |

### 3.4 成功标准

- [ ] 模块数量：从53个减少到31-32个（减少38-42%）
- [ ] 代码行数：减少约9,400行（减少约10%）
- [ ] 编译时间：完全编译减少30-40%
- [ ] 依赖深度：平均减少到2-3层（减少40%）
- [ ] 分支因子：平均减少到2-3个（减少33%）
- [ ] 最大依赖数量：减少到8个（减少47%）
- [ ] 测试覆盖率：保持不下降
- [ ] 向后兼容性：100%保持

---

## 四、任务7：实现ARM SMMU

### 4.1 当前状态
- **完成度**：0%（准备中）
- **已完成**：
  - ✅ 已识别SMMU实现的重要性
  - ✅ 已纳入中期计划

### 4.2 实施路线

#### 阶段1：SMMUv3规范研究（第1-2周）

**目标**：深入研究ARM SMMUv3规范

**工作内容**：
1. **ARM SMMUv3规范阅读**
   - [ ] 阅读ARM SMMUv3规范文档（Architecture Reference Manual ARMv8-A）
   - [ ] 研究SMMU架构概述
   - [ ] 理解SMMU编程模型

2. **SMMU功能分析**
   - [ ] 分析SMMU核心功能
   - [ ] 理解命令队列（Command Queue）
   - [ ] 理解事件队列（Event Queue）
   - [ ] 理解表配置（Stage/Stream Table）
   - [ ] 理解中断处理

3. **IOMMU虚拟化分析**
   - [ ] 分析IOMMU虚拟化架构
   - [ ] 理解地址空间管理
   - [ ] 理解设备访问控制
   - [ ] 分析与其他虚拟化技术的集成

4. **参考实现研究**
   - [ ] 研究Linux KVM的SMMU实现
   - [ ] 研究QEMU的SMMU实现
   - [ ] 分析最佳实践和设计模式
   - [ ] 识别性能优化机会

**产出**：
- SMMUv3规范研究文档
- SMMU架构设计文档
- 功能清单和优先级
- 参考实现分析报告

#### 阶段2：SMMU架构设计（第3-4周）

**目标**：设计SMMUv3架构

**工作内容**：
1. **模块架构设计**
   ```
   vm-iommu/
   ├── Cargo.toml
   └── src/
       ├── lib.rs (公共接口)
       ├── smmu.rs (SMMU核心)
       ├── command_queue.rs (命令队列)
       ├── event_queue.rs (事件队列)
       ├── config.rs (表配置)
       └── interrupt.rs (中断处理)
   ```

2. **SMMU核心接口设计**
   ```rust
   pub trait SMMU: Send + Sync {
       fn initialize(&mut self) -> Result<(), SmmuError>;
       fn translate(&self, addr: u64) -> Result<u64, SmmuError>;
       fn map_page(&mut self, addr: u64, size: usize) -> Result<(), SmmuError>;
       fn unmap_page(&mut self, addr: u64) -> Result<(), SmmuError>;
       fn invalidate(&mut self) -> Result<(), SmmuError>;
       fn handle_interrupt(&mut self) -> Result<(), SmmuError>;
   }
   ```

3. **命令队列设计**
   - [ ] 命令队列结构设计
   - [ ] 命令优先级
   - [ ] 队列管理
   - [ ] 队列深度控制

4. **事件队列设计**
   - [ ] 事件队列结构设计
   - [ ] 事件优先级
   - [ ] 事件处理机制

5. **表配置设计**
   - [ ] Stage/Stream Table结构
   - [ ] 表项配置
   - [ ] 查找算法

6. **中断处理设计**
   - [ ] 中断类型定义
   - [ ] 中断优先级
   - [ ] 中断处理流程

**产出**：
- SMMU模块架构设计
- 接口定义
- 数据结构设计
- 组件交互图

#### 阶段3：SMMU核心功能实现（第5-10周）

**目标**：实现SMMUv3核心功能

**工作内容**：
1. **命令队列实现**（第5周）
   - [ ] 实现命令队列数据结构
   - [ ] 实现命令入队/出队
   - [ ] 实现命令执行
   - [ ] 测试验证

2. **事件队列实现**（第6周）
   - [ ] 实现事件队列数据结构
   - [ ] 实现事件入队/出队
   - [ ] 实现事件处理
   - [ ] 测试验证

3. **表配置实现**（第7周）
   - [ ] 实现Stage/Stream Table
   - [ ] 实现表项配置
   - [ ] 实现查找算法
   - [ ] 测试验证

4. **地址转换实现**（第7-8周）
   - [ ] 实现地址转换逻辑
   - [ ] 实现页表管理
   - [ ] 实现缓存优化
   - [ ] 测试验证

5. **中断处理实现**（第9周）
   - [ ] 实现中断类型
   - [ ] 实现中断优先级
   - [ ] 实现中断处理流程
   - [ ] 测试验证

6. **SMMU主接口实现**（第10周）
   - [ ] 实现SMMU trait
   - [ ] 整合所有子模块
   - [ ] 实现初始化
   - [ ] 测试验证

**产出**：
- 完整的SMMU核心功能
- 命令队列模块
- 事件队列模块
- 表配置模块
- 地址转换模块
- 中断处理模块

#### 阶段4：IOMMU虚拟化（第11-14周）

**目标**：实现IOMMU虚拟化功能

**工作内容**：
1. **IOMMU设备管理**（第11周）
   - [ ] 设备注册
   - [ ] 设备移除
   - [ ] 设备访问控制
   - [ ] 设备权限管理

2. **IOMMU配置接口**（第12周）
   - [ ] 配置空间管理
   - [ ] 域配置
   - [ ] 流配置
   - [ ] 测试验证

3. **IOMMU翻译**（第13周）
   - [ ] 设备地址翻译
   - [ ] 地址空间映射
   - [ ] 事务处理
   - [ ] 测试验证

4. **IOMMU集成**（第14周）
   - [ ] 与vm-core集成
   - [ ] 与vm-mem集成
   - [ ] 与vm-device集成
   - [ ] 测试验证

**产出**：
- IOMMU设备管理
- IOMMU配置接口
- IOMMU翻译功能
- 完整的集成

#### 阶段5：最终验证和文档（第15-16周）

**目标**：完成SMMU实现并进行最终验证

**工作内容**：
1. **功能测试**
   - [ ] 单元测试
   - [ ] 集成测试
   - [ ] 性能测试

2. **SMMU基准测试**
   - [ ] 性能基准测试套件
   - [ ] 压力测试
   - [ ] 回归测试

3. **文档更新**
   - [ ] 更新架构文档
   - [ ] 更新API文档
   - [ ] 创建SMMU使用指南

**产出**：
- 测试报告
- 性能基准测试报告
- 更新的文档体系

### 4.3 关键里程碑

| 里程碑 | 时间 | 验收标准 | 依赖 |
|--------|------|---------|------|
| S1：SMMUv3规范研究完成 | 第2周 | 研究文档完成 | - |
| S2：SMMU架构设计完成 | 第5周 | 设计文档完成 | S1 |
| S3：命令队列完成 | 第6周 | 测试通过 | S2 |
| S4：事件队列完成 | 第7周 | 测试通过 | S3 |
| S5：表配置完成 | 第8周 | 测试通过 | S4 |
| S6：地址转换完成 | 第9周 | 测试通过 | S5 |
| S7：SMMU核心完成 | 第11周 | 测试通过 | S6 |
| S8：IOMMU虚拟化完成 | 第15周 | 测试通过 | S7 |
| S9：最终验证完成 | 第17周 | 所有验证通过 | S8 |

### 4.4 成功标准

- [ ] SMMUv3核心功能：100%实现
- [ ] IOMMU虚拟化：100%实现
- [ ] 与其他模块集成：100%完成
- [ ] 测试覆盖率：>85% for SMMU
- [ ] 性能基准测试：完成
- [ ] 文档完善：100%完成

---

## 五、整体时间线

### 5.1 总体时间线

```
第0周：短期计划启动
第1-12周：短期计划完成 ✅

第13-14周：中期计划启动
第13周：任务5（RISC-V）阶段1
第14周：任务6（模块依赖）阶段1
第15-24周：任务5（RISC-V）阶段2-4
第25-36周：任务6（模块依赖）阶段2-6
第37-48周：任务5（RISC-V）阶段5-6
第49-60周：任务6（模块依赖）阶段7-9
第61-72周：任务5（RISC-V）阶段7-12
第73-84周：任务7（ARM SMMU）阶段1-5
第85-96周：任务7（ARM SMMU）阶段6-9
```

**总计**：约12-16周（3-4个月）

### 5.2 资源分配

| 阶段 | 周数 | 估计人周 | 主要人员 |
|------|------|----------|---------|
| 中期计划准备 | 2周 | 2人 | 核心团队 |
| 任务5（RISC-V） | 16周 | 32人 | 架构团队 |
| 任务6（模块依赖） | 24周 | 48人 | 全体团队 |
| 任务7（ARM SMMU） | 24周 | 48人 | 设备团队 |

**总计**：约130人周

---

## 六、风险和缓解

### 6.1 高优先级风险

#### 风险1：预先存在的编译错误
**风险描述**：vm-engine-jit模块有约60个预先存在的编译错误
**影响范围**：所有模块
**影响程度**：高
**概率**：高
**缓解措施**：
- ✅ 已避免修改有预先错误的模块
- ✅ 专注于分析、规划和文档工作
- ⏳ 待后续修复这些错误
- ⏳ 避免在有编译错误的模块中进行大量修改

#### 风险2：模块合并导致的API破坏
**风险描述**：模块合并可能破坏现有API
**影响范围**：所有依赖这些模块的代码
**影响程度**：高
**概率**：中
**缓解措施**：
- 保持向后兼容的API
- 提供迁移指南
- 分阶段迁移
- 每个阶段后进行测试验证
- 准备回滚计划

#### 风险3：测试覆盖下降
**风险描述**：模块合并可能导致测试覆盖率下降
**影响范围**：测试套件
**影响程度**：中
**概率**：中
**缓解措施**：
- 保留所有测试
- 更新测试引用
- 增加集成测试
- 每个阶段后验证测试覆盖率

#### 风险4：SMMUv3规范复杂
**风险描述**：SMMUv3规范非常复杂
**影响范围**：任务7（ARM SMMU）
**影响程度**：高
**概率**：高
**缓解措施**：
- 详细研究规范文档
- 参考其他实现（Linux KVM, QEMU）
- 分阶段实现（核心功能 → IOMMU → 集成）
- 充分的测试验证

---

## 七、依赖关系

### 7.1 任务间依赖

```
短期计划（任务1-6）
    ↓
任务5（完善RISC-V支持）
    ↓
任务6（简化模块依赖）
    ↓
任务7（实现ARM SMMU）
```

### 7.2 关键路径

**主关键路径**：任务6（简化模块依赖）→ 任务7（实现ARM SMMU）

**理由**：
- 任务7的SMMU依赖于清晰的模块结构
- 任务6的模块简化是SMMU的基础
- 如果模块结构不清晰，SMMU难以实现

**次关键路径**：任务5（完善RISC-V支持）

**理由**：
- RISC-V支持是中期计划的核心目标
- 独立于其他模块的架构

### 7.3 里程碑依赖

```
短期计划完成
    ↓
任务5阶段1（扩展设计）
    ↓
任务6阶段1（准备完成）
    ↓
任务5阶段2（实现M/A扩展）
    ↓
任务6阶段2（编码解码合并）
    ↓
任务5阶段3（实现F/D/C扩展）
    ↓
任务6阶段3（平台模块合并）
    ↓
任务5阶段4（实现特权指令）
    ↓
任务6阶段4（辅助模块合并）
    ↓
任务5阶段5（优化）
    ↓
任务7阶段1（SMMU研究）
    ↓
任务6阶段5（监控服务合并）
    ↓
任务7阶段2（SMMU设计）
    ↓
任务6阶段6（测试模块整合）
    ↓
任务7阶段3（SMMU核心）
    ↓
任务6阶段7（最终验证）
    ↓
任务7阶段4（IOMMU）
    ↓
任务7阶段5（集成测试）
    ↓
任务7阶段6（最终验证）
```

---

## 八、成功标准

### 8.1 中期计划总体

| 指标 | 目标 | 当前 | 状态 |
|------|------|------|------|
| 完善RISC-V支持 | 80% | 35% | 🔄 进行中 |
| 简化模块依赖 | 减少38-42% | 10% | 🔄 进行中 |
| 实现ARM SMMU | 完整 | 0% | ⏸ 准备中 |
| 中期计划总体 | - | - | - |

---

## 九、下一步行动

### 立即行动（本周）

1. **继续任务5（完善RISC-V支持）**：
   - 继续扩展模块设计
   - 开始实现基础扩展指令

2. **启动任务6（简化模块依赖）**：
   - 开始依赖关系图绘制
   - 开始API兼容性评估

3. **启动任务7（实现ARM SMMU）**：
   - 开始SMMUv3规范研究
   - 阅读ARM官方文档

### 短期行动（1-2个月）

1. **任务5（RISC-V支持）**：
   - 完成M/A/F扩展实现
   - 开始D/C扩展实现
   - 设计特权指令模块

2. **任务6（模块依赖）**：
   - 开始编码/解码模块合并
   - 开始平台相关模块合并

3. **任务7（SMMU）**：
   - 完成SMMU规范研究
   - 开始SMMU架构设计

### 中期行动（3-4个月）

1. **任务5（RISC-V支持）**：
   - 完成所有扩展实现
   - 实现特权指令
   - 完善RISC-V特定优化

2. **任务6（模块依赖）**：
   - 完成所有模块合并
   - 最终验证和文档

3. **任务7（SMMU）**：
   - 实现SMMU核心功能
   - 实现IOMMU虚拟化
   - 集成测试

---

**路线图创建时间**：2024年12月24日
**总预计实施时间**：12-16周（3-4个月）
**建议优先级**：任务6（模块依赖）→ 任务7（SMMU）→ 任务5（RISC-V）
**关键建议**：先进行充分的规划、研究和设计，然后再进行代码实施，以避免大规模修改带来的风险。

